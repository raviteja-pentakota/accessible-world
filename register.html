<!DOCTYPE html>
<html>
<head>
    <title>Register</title>
</head>
<body>
    <h2>Register</h2>
    <form id="registerForm">
        <label for="fullName">Full Name:</label><br>
        <input type="text" id="fullName" required><br>

        <label for="mobile">Mobile:</label><br>
        <input type="text" id="mobile" required><br>

        <label for="email">Email:</label><br>
        <input type="email" id="email" required><br>

        <label for="password">Password:</label><br>
        <input type="password" id="password" required><br>

        <label for="referralInput">Referral Code:</label><br>
        <input type="text" id="referralInput" readonly><br><br>

        <button type="submit">Register</button>
    </form>

    <p>Already a user? <a href="index.html">Click here to login</a></p>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBWtr_ZwK8hfA1We-yq9uUOjw5C6wXhx0k",
            authDomain: "accessibleworld-7f599.firebaseapp.com",
            projectId: "accessibleworld-7f599",
            storageBucket: "accessibleworld-7f599.appspot.com",
            messagingSenderId: "264437218598",
            appId: "1:264437218598:web:cae58c1e578c7b08b815e7",
            measurementId: "G-1QRWXYRZ76"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const urlParams = new URLSearchParams(window.location.search);
        const referralCode = urlParams.get('ref');

        if (referralCode) {
            document.getElementById("referralInput").value = referralCode;
        }

async function registerUser(event) {
            event.preventDefault();

            const fullName = document.getElementById("fullName").value;
            const mobile = document.getElementById("mobile").value;
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await auth.currentUser.getIdToken();

                const uid = auth.currentUser.uid;
                const generatedReferralCode = uid.substring(0, 8);

                await setDoc(doc(db, "users", uid), {
                    fullName,
                    mobile,
                    email,
                    uid,
                    referralCode: generatedReferralCode,
                    referredBy: referralCode || null,
                    paymentStatus: "pending",
                    level1: [],
                    level2: [],
                    level3: [],
                    level4: [],
                    level5: []
                });

                if (referralCode) {
                    console.log("Referral Code from URL:", referralCode);
                    let referrerUID = null;

                    // Check if the referral code exists in the 'referralCodes' collection
                    const referralDoc = await getDoc(doc(db, "referralCodes", referralCode));
                    console.log("referralDoc.exists():", referralDoc.exists());
                    if (referralDoc.exists()) {
                        referrerUID = referralDoc.data().uid;
                        console.log("Found in 'referralCodes', referrerUID:", referrerUID);
                    } else {
                        // If not found in 'referralCodes', check if it's a user's UID
                        const userDoc = await getDoc(doc(db, "users", referralCode));
                        console.log("userDoc.exists():", userDoc.exists());
                        if (userDoc.exists()) {
                            referrerUID = userDoc.id;
                            console.log("Found as userId, referrerUID:", referrerUID);
                        }
                    }

                    console.log("Final referrerUID:", referrerUID);
                    if (referrerUID) {
                        await updateDoc(doc(db, "users", referrerUID), {
                            level1: arrayUnion(uid)
                        });
                    } else {
                        console.log("No valid referrerUID found.");
                    }
                }

                alert("Registration successful! Please log in.");
                window.location.href = "index.html";

            } catch (error) {
                console.error("Registration Error:", error.code, error.message);
                alert(error.message);
            }
        }
        document.getElementById("registerForm").addEventListener("submit", registerUser);
    </script>
</body>
</html>