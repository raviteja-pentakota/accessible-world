<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant Login & Registration | Accessible World</title>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background-color: #ffffff; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 600px; width: 100%; transition: transform 0.3s ease; }
        h2 { text-align: center; color: #1e3a8a; margin-bottom: 20px; font-weight: 700; }
        .tab-container { display: flex; justify-content: space-around; margin-bottom: 25px; border-bottom: 2px solid #e2e8f0; }
        .tab-button {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            border: none;
            background: none;
            transition: color 0.3s, border-bottom-color 0.3s;
            position: relative;
        }
        .tab-button.active {
            color: #1e3a8a;
            border-bottom: 3px solid #1e3a8a;
        }
        .form-section { display: none; }
        .form-section.active { display: block; }
        
        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #4b5563; }
        input[type="text"], input[type="number"], input[type="email"], input[type="password"], input[type="tel"], select {
            width: calc(100% - 24px);
            padding: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            transition: border-color 0.3s, box-shadow 0.3s;
            box-sizing: border-box;
            font-size: 16px;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 18px; }
        .checkbox-group label { display: flex; align-items: center; font-weight: 400; color: #4b5563; margin-bottom: 0; }
        .checkbox-group input[type="checkbox"] { margin-right: 8px; width: auto; }
        
        button {
            width: 100%;
            padding: 15px;
            background-color: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 700;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        button:hover {
            background-color: #1d4ed8;
            transform: translateY(-2px);
        }
        button:active {
            transform: translateY(0);
        }
        
        #statusMessage {
            text-align: center;
            margin-top: 20px;
            font-weight: 600;
            padding: 10px;
            border-radius: 8px;
            display: none;
        }
        .status-success { background-color: #d1fae5; color: #065f46; }
        .status-error { background-color: #fee2e2; color: #991b1b; }
        .status-info { background-color: #dbeafe; color: #1e40af; }

        /* Modal for displaying messages */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 400px;
            border-radius: 10px;
            text-align: center;
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>Paid Assistant Services</h2>
    <div class="tab-container">
        <button id="register-tab" class="tab-button active">Register</button>
        <button id="login-tab" class="tab-button">Login</button>
    </div>

    <div id="register-section" class="form-section active">
        <form id="registerForm">
            <div class="form-group">
                <label for="reg-name">Full Name:</label>
                <input type="text" id="reg-name" required>
            </div>
            <div class="form-group">
                <label for="reg-age">Age:</label>
                <input type="number" id="reg-age" required>
            </div>
            <div class="form-group">
                <label for="reg-email">Email:</label>
                <input type="email" id="reg-email" required>
            </div>
            <div class="form-group">
                <label for="reg-password">Password:</label>
                <input type="password" id="reg-password" required>
            </div>
            <div class="form-group">
                <label for="reg-confirmPassword">Confirm Password:</label>
                <input type="password" id="reg-confirmPassword" required>
            </div>
            <div class="form-group">
                <label for="reg-mobileNumber">Mobile Number:</label>
                <input type="tel" id="reg-mobileNumber" required>
            </div>
            <div class="form-group">
                <label for="reg-education">Education Qualification:</label>
                <input type="text" id="reg-education" required>
            </div>
            <div class="form-group">
                <label for="reg-city">Current City:</label>
                <input type="text" id="reg-city" required>
            </div>
            <div class="form-group">
                <label for="reg-availability">Availability:</label>
                <select id="reg-availability" required>
                    <option value="">Select Availability</option>
                    <option value="Full Time">Full Time</option>
                    <option value="Part Time">Part Time</option>
                    <option value="Weekends">Weekends</option>
                    <option value="Call Availability">Call Availability When Needed</option>
                </select>
            </div>
            <div class="form-group">
                <label>Vehicle Availability with Driving License:</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" id="reg-car"> Car</label>
                    <label><input type="checkbox" id="reg-bike"> Bike</label>
                    <label><input type="checkbox" id="reg-auto"> Auto</label>
                </div>
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="reg-travel"> Willing to Travel All Over India</label>
            </div>
            <button type="submit">Register</button>
        </form>
    </div>

    <div id="login-section" class="form-section">
        <form id="loginForm">
            <div class="form-group">
                <label for="login-email">Email:</label>
                <input type="email" id="login-email" required>
            </div>
            <div class="form-group">
                <label for="login-password">Password:</label>
                <input type="password" id="login-password" required>
            </div>
            <button type="submit">Login</button>
        </form>
    </div>
    
    <div id="statusMessage" style="display:none;"></div>
</div>

<div id="messageModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="document.getElementById('messageModal').style.display='none';">&times;</span>
        <p id="modalMessage"></p>
    </div>
</div>

<script type="module">
    // Import Firebase services
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    // Firebase config from your project
    const firebaseConfig = {
      apiKey: "AIzaSyBZUQXgfdDHrntbBVSVFf8Vvtp9V5qnERg",
      authDomain: "accessible-learn-and-win-ad21f.firebaseapp.com",
      projectId: "accessible-learn-and-win-ad21f",
      storageBucket: "accessible-learn-and-win-ad21f.appspot.com",
      messagingSenderId: "299849578412",
      appId: "1:299849578412:web:1e66a3292e35578f102c09",
      measurementId: "G-G832YW57EK"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Get form and UI elements
    const registerForm = document.getElementById("registerForm");
    const loginForm = document.getElementById("loginForm");
    const registerTab = document.getElementById("register-tab");
    const loginTab = document.getElementById("login-tab");
    const registerSection = document.getElementById("register-section");
    const loginSection = document.getElementById("login-section");
    const statusMessage = document.getElementById("statusMessage");
    const modal = document.getElementById("messageModal");
    const modalMessage = document.getElementById("modalMessage");

    // Helper function to display messages in a modal
    function showModalMessage(message, isError = false) {
        modalMessage.textContent = message;
        modalMessage.style.color = isError ? '#991b1b' : '#065f46';
        modal.style.display = 'flex';
    }

    // Tab switching logic
    registerTab.addEventListener('click', () => {
        registerTab.classList.add('active');
        loginTab.classList.remove('active');
        registerSection.classList.add('active');
        loginSection.classList.remove('active');
    });

    loginTab.addEventListener('click', () => {
        loginTab.classList.add('active');
        registerTab.classList.remove('active');
        loginSection.classList.add('active');
        registerSection.classList.remove('active');
    });
    
    // Handle registration form submit
    registerForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        statusMessage.textContent = "Processing registration...";
        statusMessage.className = "status-info";
        statusMessage.style.display = 'block';

        const name = document.getElementById("reg-name").value;
        const age = parseInt(document.getElementById("reg-age").value);
        const email = document.getElementById("reg-email").value;
        const password = document.getElementById("reg-password").value;
        const confirmPassword = document.getElementById("reg-confirmPassword").value;
        const mobileNumber = document.getElementById("reg-mobileNumber").value;
        const education = document.getElementById("reg-education").value;
        const city = document.getElementById("reg-city").value;
        const availability = document.getElementById("reg-availability").value;
        const car = document.getElementById("reg-car").checked;
        const bike = document.getElementById("reg-bike").checked;
        const auto = document.getElementById("reg-auto").checked;
        const travel = document.getElementById("reg-travel").checked;
        
        if (password !== confirmPassword) {
            showModalMessage("Error: Passwords do not match.", true);
            statusMessage.style.display = 'none';
            return;
        }

        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;

            await setDoc(doc(db, "paid_volunteers", user.uid), {
                name,
                age,
                email,
                mobileNumber,
                education,
                city,
                availability,
                vehicles: { car, bike, auto },
                willingToTravel: travel,
                role: 'helper', // **CRITICAL FIX: Add this role field**
                submittedAt: serverTimestamp()
            });

            showModalMessage("Registration successful! You can now log in.");
            statusMessage.style.display = 'none';
            registerForm.reset();
        } catch (error) {
            console.error("Error with registration: ", error);
            let errorMessage = "Registration failed. Please try again.";
            if (error.code === 'auth/email-already-in-use') {
                errorMessage = 'This email address is already in use.';
            } else if (error.code === 'auth/weak-password') {
                errorMessage = 'The password is too weak. Please use at least 6 characters.';
            }
            showModalMessage("Error: " + errorMessage, true);
            statusMessage.style.display = 'none';
        }
    });

    // Handle login form submit
    loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        statusMessage.textContent = "Logging in...";
        statusMessage.className = "status-info";
        statusMessage.style.display = 'block';

        const email = document.getElementById("login-email").value;
        const password = document.getElementById("login-password").value;

        try {
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;

            // **CRITICAL FIX: Fetch user's role from Firestore**
            const userDocRef = doc(db, "paid_volunteers", user.uid);
            const userDocSnap = await getDoc(userDocRef);

            if (userDocSnap.exists() && userDocSnap.data().role === 'helper') {
                // Correct role, redirect to helper dashboard
                window.location.href = 'helper_dashboard.html';
            } else {
                // Incorrect role, log them out and show an error
                await signOut(auth);
                showModalMessage("Error: You do not have helper access. Please log in to the correct account.", true);
                statusMessage.style.display = 'none';
            }

        } catch (error) {
            console.error("Error with login: ", error);
            let errorMessage = "Login failed. Please check your email and password.";
            showModalMessage("Error: " + errorMessage, true);
            statusMessage.style.display = 'none';
        }
    });
    
    // Check for existing login on page load
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userDocRef = doc(db, "paid_volunteers", user.uid);
            const userDocSnap = await getDoc(userDocRef);
            
            if (userDocSnap.exists() && userDocSnap.data().role === 'helper') {
                window.location.href = 'helper_dashboard.html';
            } else {
                await signOut(auth);
            }
        }
    });
</script>
</body>
</html>