<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            min-height: 100vh;
            padding: 2rem;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            padding: 2.5rem;
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .request-card {
            background-color: #f9f9f9;
            border-left: 4px solid #3b82f6;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
        }
        .request-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #777;
        }
        /* Custom styles for tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px 15px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #0056b3;
            color: #fff;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        tr:hover {
            background-color: #e9e9e9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-900">Admin Dashboard</h1>
            <div class="flex items-center space-x-4">
                <span id="user-info" class="text-gray-600"></span>
                <button id="logout-btn" class="px-4 py-2 text-sm font-semibold text-white bg-red-600 rounded-lg shadow-md hover:bg-red-700 transition duration-300">Logout</button>
            </div>
        </div>

        <div class="table-section mb-8">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Sighted Assistance Requests</h3>
            <p id="loading-requests" class="loading">Loading requests...</p>
            <table id="requestsTable" style="display:none;">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Contact</th>
                        <th>Gender</th>
                        <th>Assistance For</th>
                        <th>Pickup Address</th>
                        <th>Travel Details</th>
                        <th>Submitted At</th>
                    </tr>
                </thead>
                <tbody id="requestsBody"></tbody>
            </table>
        </div>

        <div class="table-section">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Paid Volunteer Registrations</h3>
            <p id="loading-volunteers" class="loading">Loading volunteer data...</p>
            <table id="volunteersTable" style="display:none;">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Age</th>
                        <th>Email</th>
                        <th>Mobile Number</th>
                        <th>City</th>
                        <th>Availability</th>
                        <th>Vehicles</th>
                        <th>Willing to Travel</th>
                        <th>Submitted At</th>
                    </tr>
                </thead>
                <tbody id="volunteersBody"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: These variables are provided by the canvas environment. Do not change them.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const requestsBody = document.getElementById("requestsBody");
        const volunteersBody = document.getElementById("volunteersBody");
        const loadingRequests = document.getElementById("loading-requests");
        const loadingVolunteers = document.getElementById("loading-volunteers");
        const requestsTable = document.getElementById("requestsTable");
        const volunteersTable = document.getElementById("volunteersTable");
        const logoutBtn = document.getElementById('logout-btn');
        const userInfoSpan = document.getElementById('user-info');

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Function to render the requests table
        const renderRequests = (docs) => {
            requestsBody.innerHTML = '';
            if (docs.length === 0) {
                loadingRequests.textContent = "No assistance requests found.";
                requestsTable.style.display = 'none';
            } else {
                docs.forEach(doc => {
                    const data = doc.data();
                    const row = document.createElement("tr");
                    const submittedDate = data.submittedAt?.toDate ? data.submittedAt.toDate().toLocaleString() : 'N/A';
                    
                    let travelInfo = 'N/A';
                    if (data.need === 'travel') {
                        travelInfo = `From: ${data.from || 'N/A'}<br>To: ${data.to || 'N/A'}<br>Days: ${data.days || 'N/A'}`;
                    }

                    row.innerHTML = `
                        <td>${data.name || 'N/A'}</td>
                        <td>${data.phone || 'N/A'} / ${data.altPhone || 'N/A'}</td>
                        <td>${data.gender || 'N/A'}</td>
                        <td>${data.need || 'N/A'}</td>
                        <td>${data.pickupAddress || 'N/A'}</td>
                        <td>${travelInfo}</td>
                        <td>${submittedDate}</td>
                    `;
                    requestsBody.appendChild(row);
                });
                loadingRequests.style.display = 'none';
                requestsTable.style.display = 'table';
            }
        };

        // Function to render the volunteers table
        const renderVolunteers = (docs) => {
            volunteersBody.innerHTML = '';
            if (docs.length === 0) {
                loadingVolunteers.textContent = "No volunteer registrations found.";
                volunteersTable.style.display = 'none';
            } else {
                docs.forEach(doc => {
                    const data = doc.data();
                    const row = document.createElement("tr");
                    const submittedDate = data.submittedAt?.toDate ? data.submittedAt.toDate().toLocaleString() : 'N/A';
                    
                    const vehicles = (data.vehicles) ?
                        Object.keys(data.vehicles).filter(key => data.vehicles[key]).join(", ") : 'None';

                    row.innerHTML = `
                        <td>${data.name || 'N/A'}</td>
                        <td>${data.age || 'N/A'}</td>
                        <td>${data.email || 'N/A'}</td>
                        <td>${data.mobileNumber || 'N/A'}</td>
                        <td>${data.city || 'N/A'}</td>
                        <td>${data.availability || 'N/A'}</td>
                        <td>${vehicles}</td>
                        <td>${data.willingToTravel ? 'Yes' : 'No'}</td>
                        <td>${submittedDate}</td>
                    `;
                    volunteersBody.appendChild(row);
                });
                loadingVolunteers.style.display = 'none';
                volunteersTable.style.display = 'table';
            }
        };

        // Handle user authentication and data loading
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("User is signed in. UID:", user.uid);
                userInfoSpan.textContent = `User ID: ${user.uid}`;
                
                // Set up real-time listener for requests
                const requestsCollection = collection(db, `artifacts/${appId}/public/data/assistanceRequests`);
                onSnapshot(requestsCollection, (querySnapshot) => {
                    renderRequests(querySnapshot.docs);
                }, (error) => {
                    console.error("Error fetching requests:", error);
                    loadingRequests.textContent = 'Failed to load requests. Please try again.';
                });

                // Set up real-time listener for volunteers
                const volunteersCollection = collection(db, `artifacts/${appId}/public/data/paid_volunteers`);
                onSnapshot(volunteersCollection, (querySnapshot) => {
                    renderVolunteers(querySnapshot.docs);
                }, (error) => {
                    console.error("Error fetching volunteer data:", error);
                    loadingVolunteers.textContent = 'Failed to load volunteer data. Please try again.';
                });

            } else {
                console.log("User is signed out or not authenticated. Signing in anonymously.");
                loadingRequests.textContent = 'Please wait, authenticating...';
                loadingVolunteers.textContent = 'Please wait, authenticating...';
                
                signInAnonymously(auth).catch(error => {
                    console.error("Anonymous sign-in failed:", error);
                    loadingRequests.textContent = 'Authentication failed. Please refresh.';
                    loadingVolunteers.textContent = 'Authentication failed. Please refresh.';
                });
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                console.log("User signed out.");
            } catch (error) {
                console.error("Logout Error:", error);
            }
        });
    </script>
</body>
</html>
