<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard | Accessible World</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f9fa; padding: 20px; color: #333; }
    .container { max-width: 1200px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h2 { color: #0056b3; text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 12px 15px; border: 1px solid #ddd; text-align: left; }
    th { background-color: #0056b3; color: #fff; }
    tr:nth-child(even) { background-color: #f2f2f2; }
    tr:hover { background-color: #e9e9e9; }
    .loading { text-align: center; padding: 20px; font-style: italic; color: #777; }
    .table-section { margin-top: 40px; }
    input { padding: 8px; margin: 5px; border-radius: 4px; border: 1px solid #ccc; }
    button { padding: 10px 20px; border: none; border-radius: 4px; background-color: #007bff; color: white; cursor: pointer; }
    button:hover { background-color: #0056b3; }
  </style>
</head>
<body>

  <div class="container">
    <div id="dashboard">
        <h2>Admin Dashboard</h2>
        <div class="table-section">
            <h3>Sighted Assistance Requests</h3>
            <div id="loading-requests" class="loading">Loading requests...</div>
            <table id="requestsTable" style="display:none;">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Contact Number</th>
                        <th>Gender</th>
                        <th>Assistance For</th>
                        <th>Travel Details</th>
                        <th>Submitted At</th>
                    </tr>
                </thead>
                <tbody id="requestsBody"></tbody>
            </table>
        </div>

        <div class="table-section">
            <h3>Paid Volunteer Registrations</h3>
            <div id="loading-volunteers" class="loading">Loading volunteer data...</div>
            <table id="volunteersTable" style="display:none;">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Age</th>
                        <th>Email</th>
                        <th>City</th>
                        <th>Availability</th>
                        <th>Vehicles</th>
                        <th>Travel Willingness</th>
                        <th>Submitted At</th>
                    </tr>
                </thead>
                <tbody id="volunteersBody"></tbody>
            </table>
        </div>
    </div>
  </div>

  <script type="module">
    // Firebase SDK imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    // This Firebase configuration matches your form's code snippets.
    const firebaseConfig = {
      apiKey: "AIzaSyBZUQXgfdDHrntbBVSVFf8Vvtp9V5qnERg",
      authDomain: "accessible-learn-and-win-ad21f.firebaseapp.com",
      projectId: "accessible-learn-and-win-ad21f",
      storageBucket: "accessible-learn-and-win-ad21f.appspot.com",
      messagingSenderId: "299849578412",
      appId: "1:299849578412:web:1e66a3292e35578f102c09",
      measurementId: "G-G832YW57EK"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const requestsBody = document.getElementById("requestsBody");
    const volunteersBody = document.getElementById("volunteersBody");
    const loadingRequests = document.getElementById("loading-requests");
    const loadingVolunteers = document.getElementById("loading-volunteers");
    const requestsTable = document.getElementById("requestsTable");
    const volunteersTable = document.getElementById("volunteersTable");

    // Function to fetch and display assistance requests
    async function fetchRequests() {
      try {
        console.log("Attempting to fetch data from 'assistanceRequests'...");
        const querySnapshot = await getDocs(collection(db, "assistanceRequests"));
        requestsBody.innerHTML = '';
        
        if (querySnapshot.empty) {
          console.log("No assistance requests found in the database.");
          loadingRequests.textContent = "No assistance requests found.";
          return;
        }
        
        console.log(`Found ${querySnapshot.size} assistance requests.`);

        const requests = [];
        querySnapshot.forEach((doc) => {
            requests.push(doc.data());
        });
        
        // Sort the data by submittedAt in descending order (newest first)
        requests.sort((a, b) => {
            const dateA = a.submittedAt?.toDate ? a.submittedAt.toDate() : new Date(0);
            const dateB = b.submittedAt?.toDate ? b.submittedAt.toDate() : new Date(0);
            return dateB - dateA;
        });
        
        requests.forEach((data) => {
          const row = document.createElement("tr");
          const submittedDate = data.submittedAt?.toDate ? data.submittedAt.toDate().toLocaleString() : 'N/A';
          let travelInfo = 'N/A';
          if (data.need === 'travel') {
            travelInfo = `From: ${data.from || 'N/A'}, To: ${data.to || 'N/A'}, Days: ${data.days || 'N/A'}`;
          }

          row.innerHTML = `
            <td>${data.name || 'N/A'}</td>
            <td>${data.phone || 'N/A'} / ${data.altPhone || 'N/A'}</td>
            <td>${data.gender || 'N/A'}</td>
            <td>${data.need || 'N/A'}</td>
            <td>${travelInfo}</td>
            <td>${submittedDate}</td>
          `;
          requestsBody.appendChild(row);
        });
      } catch (err) {
        console.error("Error fetching assistance requests:", err);
        loadingRequests.textContent = "Failed to load requests. You may not have permission.";
      } finally {
        loadingRequests.style.display = 'none';
        requestsTable.style.display = 'table';
      }
    }

    // Function to fetch and display paid volunteer data
    async function fetchVolunteers() {
      try {
        // This is the correct collection name from your form's code
        console.log("Attempting to fetch data from 'paid_volunteers'...");
        const querySnapshot = await getDocs(collection(db, "paid_volunteers"));
        volunteersBody.innerHTML = '';

        if (querySnapshot.empty) {
          console.log("No volunteer registrations found in the database.");
          loadingVolunteers.textContent = "No volunteer registrations found.";
          return;
        }

        console.log(`Found ${querySnapshot.size} volunteer registrations.`);

        const volunteers = [];
        querySnapshot.forEach((doc) => {
            volunteers.push(doc.data());
        });

        // Sort the data by submittedAt in descending order (newest first)
        volunteers.sort((a, b) => {
            const dateA = a.submittedAt?.toDate ? a.submittedAt.toDate() : new Date(0);
            const dateB = b.submittedAt?.toDate ? b.submittedAt.toDate() : new Date(0);
            return dateB - dateA;
        });

        volunteers.forEach((data) => {
            const row = document.createElement("tr");
            const submittedDate = data.submittedAt?.toDate ? data.submittedAt.toDate().toLocaleString() : 'N/A';
            // Corrected to handle `vehicles` object from the form
            const vehicles = (data.vehicles) ? 
                Object.keys(data.vehicles).filter(key => data.vehicles[key]).join(", ") : 'None';

            row.innerHTML = `
                <td>${data.name || 'N/A'}</td>
                <td>${data.age || 'N/A'}</td>
                <td>${data.email || 'N/A'}</td>
                <td>${data.city || 'N/A'}</td>
                <td>${data.availability || 'N/A'}</td>
                <td>${vehicles}</td>
                <td>${data.willingToTravel ? 'Yes' : 'No'}</td>
                <td>${submittedDate}</td>
            `;
            volunteersBody.appendChild(row);
        });
      } catch (err) {
        console.error("Error fetching volunteer data:", err);
        loadingVolunteers.textContent = "Failed to load volunteer data. You may not have permission.";
      } finally {
        loadingVolunteers.style.display = 'none';
        volunteersTable.style.display = 'table';
      }
    }

    // Immediately fetch data on page load
    fetchRequests();
    fetchVolunteers();
  </script>

</body>
</html>
