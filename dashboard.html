<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Dashboard | Accessible World Tutorials</title>
    <style>
        body { font-family: Arial, sans-serif; padding:20px; background:#f0f2f5; display: flex; flex-direction: column; min-height: 100vh; }
        .card { background:#fff; border-radius:8px; padding:20px; margin-bottom:20px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
        button { padding:10px 20px; border:none; background:#007bff; color:#fff; border-radius:4px; cursor:pointer; }
        button:hover { background:#0056b3; }
        ul { padding-left:20px; }
        #referralSection { display:none; }
        #withdraw-status { margin-top:10px; color:green; }
        table { width:100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #f9f9f9; }
        .admin-section { background: #fffbe6; padding: 20px; margin-top: 30px; border: 1px solid #ffe58f; border-radius: 8px; }
        .withdrawal-card { border-bottom: 1px solid #ddd; padding: 10px 0; }
        .withdrawal-card:last-child { border-bottom: none; }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 2; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto; /* Adjusted margin for slightly higher position */
            padding: 20px;
            border: 1px solid #888;
            width: 90%; /* Increased width for better mobile view */
            max-width: 600px; /* Max width for larger screens */
            border-radius: 8px;
            position: relative;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
        }

        .modal-input-group {
            margin-bottom: 15px;
        }

        .modal-input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .modal-input-group select,
        .modal-input-group input[type="text"],
        .modal-input-group input[type="number"],
        .modal-input-group input[type="file"] {
            width: calc(100% - 12px);
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .modal-input-group textarea {
            width: calc(100% - 12px);
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            resize: vertical;
        }

        .modal-actions {
            text-align: right;
        }

        .modal-actions button {
            margin-left: 10px;
        }

        /* Footer Styles */
        footer {
            background: #333;
            color: #fff;
            padding: 10px 20px;
            text-align: center;
            margin-top: auto; /* Push footer to the bottom */
            border-radius: 0 0 8px 8px;
        }

        footer a {
            color: #fff;
            text-decoration: none;
            margin: 0 10px;
        }

        footer a:hover {
            text-decoration: underline;
        }

        /* Accessibility helper class to visually hide but keep accessible */
        .visually-hidden {
            position: absolute !important;
            height: 1px;
            width: 1px;
            overflow: hidden;
            clip: rect(1px, 1px, 1px, 1px);
            white-space: nowrap;
        }

        /* Styles for blurring main content when modal is open */
        body.modal-open > *:not(.modal) {
            filter: blur(3px); /* Slightly less blur for better performance */
            pointer-events: none;
            user-select: none;
        }

        /* Styles for profile dropdown */
        .profile-container {
            position: relative;
            display: inline-block;
            float: right; /* To align it to the right */
        }

        .profile-dropdown {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            right: 0; /* Align dropdown to the right of the button */
            border-radius: 4px;
            padding: 10px;
            top: 40px; /* Position below the button */
        }

        .profile-dropdown p {
            margin: 5px 0;
            padding: 0;
            font-size: 14px;
        }

        .profile-dropdown button {
            width: 100%;
            margin-top: 10px;
        }

        /* Payment details section in modal */
        #paymentMethodDetails {
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        #paymentMethodDetails div {
            margin-bottom: 10px;
        }
#paymentMethodDetails img {
    width: 100%;
    max-width: 350px;
    height: auto;
    display: block;
    margin: 10px auto;
    border: 1px solid #ccc;
    padding: 5px;
    box-sizing: border-box;

    /* Image rendering for sharp display */
    image-rendering: auto;         /* Default fallback */
    image-rendering: crisp-edges;  /* For sharp edges on supported browsers */
    image-rendering: -webkit-optimize-contrast; /* Safari/Chrome (optional) */
}
        .instruction-box {
            background-color: #e9f7ef;
            border: 1px solid #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .payment-display-section {
            display: none; /* Hidden by default, shown by JS */
            padding: 10px;
            border: 1px dashed #ccc;
            margin-bottom: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        .payment-display-section p {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>Welcome to Accessible World Tutorials</h1>
        <div class="profile-container">
            <button id="profileBtn" aria-expanded="false" aria-controls="profileDetails">Profile</button>
            <div id="profileDetails" class="profile-dropdown">
                <p><strong>Name:</strong> <span id="user-name"></span></p>
                <p><strong>Mobile:</strong> <span id="user-mobile"></span></p>
                <p><strong>Email:</strong> <span id="user-email"></span></p>
                <p><strong>Payment Status:</strong> <span id="user-payment-status"></span></p>
                <button id="logout" style="background:#dc3545">Logout</button>
            </div>
        </div>

        <h2>Your Referral Link</h2>
        <p><span id="referral-link"></span></p>
        <button id="copyLink">Copy Link</button>
        <p>To understand how the referral system works, click <a href="how_referral.html" target="_blank">Click Here</a>.</p>
    </div>

    <h2>About Us</h2>
    <p> At Accessible World Tutorials, we are committed to making the digital world inclusive and accessible for everyone. Our platform offers high-quality learning materials across a wide range of topics, including HTML, JavaScript, stock market education, and the latest tech updates for Android and Windows. Whether you're looking to master web development, improve your programming skills, or gain financial knowledge, our tutorials feature clear explanations, practical examples, video lessons, and hands-on files. Accessibility is at the core of everything we do — with expert guidance, comprehensive resources, and engaging content, we ensure a learning experience that is both empowering and effective.
    By joining us with just a one-time subscription, you'll unlock free access to our full course on accessibility testing, valuable general knowledge and current affairs content, and downloadable HTML practical files with video lessons. Join now to learn, grow, and succeed in an inclusive environment designed to support your journey every step of the way.
    </p>

    <div id="payment-section">
    <div id="payment-rejected" style="display:none; margin-top:10px; background-color: #ffe6e6; border: 1px solid #ffcccc; padding: 15px; border-radius: 5px; color: #cc0000;">
<h3>Payment Not Received</h3>
        <p style="font-weight: bold;">We have not received the payment.</p>
        <p>Please share the payment successful screenshot to the mobile: <strong style="font-size: 1.1em;">7731879173</strong>.</p>
    <p>If the money was not deducted from your account or has already been refunded, click the button below to make the payment again.</p>    </div>
        <button id="initiatePaymentBtn">Join and Pay ₹1000 Membership</button>
    </div>
    <div id="payment-review" style="display:none; margin-top:10px;">
        <p style="color:orange;">Your payment is under review. We will verify it within 6 hours. Thank you for your patience!</p>
    </div>
    <div id="payment-rejected" style="display:none; margin-top:10px; background-color: #ffe6e6; border: 1px solid #ffcccc; padding: 15px; border-radius: 5px; color: #cc0000;">
        <p style="font-weight: bold;">We have not received the payment.</p>
        <p>Please share the payment successful screenshot to the mobile: <strong style="font-size: 1.1em;">7731879173</strong>.</p>
    </div>
    <div id="course-access" style="display:none; margin-top:10px;">
        <p style="color:green;">You are already a paid member. To access the paid courses, click below:</p>
        <button id="coursesBtn">Access Courses</button>
    </div>

    <div class="card">
        <button id="toggleReferral" aria-expanded="false">Show/Hide Referral Details</button>
        <div id="referralSection" style="display:none;">
            <h3>Referral Overview</h3>
            <p>Total Referrals: <span id="referral-count">0</span></p>
            <h4>Withdrawal Summary</h4>
            <p><strong>Total Withdrawn as of now:</strong> <span id="total-withdrawn-display">₹0</span></p>
            <p><strong>Available Balance:</strong> <span id="available-balance-display">₹0</span></p>
            <p>Total Earnings: <span id="total-earnings">₹0</span></p>
            <h3>Withdrawal History</h3>
            <p>You can view all your past withdrawal transactions using the link below.<br>
            <a href="withdraw_history.html">View Withdrawal History</a></p>
            <table aria-label="Referral History Table">
                <thead>
                    <tr>
                        <th>Level</th>
                        <th>Name</th>
                        <th>Mobile</th>
                        <th>Email</th>
                        <th>Payment Status</th>
                        <th>Earning</th>
                    </tr>
                </thead>
                <tbody id="referral-details"></tbody>
            </table>
            <div class="card">
                <h3>Withdraw Earnings</h3>
                <p id="withdraw-status"></p>
                <div style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">
                    <button id="withdrawBtn">Request Withdrawal</button>
                </div>
            </div>
        </div>
    </div>

    <div id="admin-section" class="admin-section" style="display:none">
        <h3>Admin: Pending Withdrawals</h3>
        <div id="withdrawal-list"></div>
        <hr>
        <h3>Admin: Pending Manual Payments</h3>
        <div id="manual-payment-list"></div>
    </div>

    <div id="withdrawModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="withdrawModalTitle" aria-describedby="withdrawModalDescription" tabindex="-1">
        <div class="modal-content">
            <button class="close-button" aria-label="Close Withdrawal Modal">&times;</button>
            <h3 id="withdrawModalTitle">Withdrawal Request</h3>
            <p id="withdrawModalDescription" class="visually-hidden">Fill out the form below to request a withdrawal of your earnings.</p>
            <div class="modal-input-group">
                <label for="totalAmount">Total Amount:</label>
                <input type="text" id="totalAmount" value="₹0" readonly>
            </div>
            <div class="modal-input-group">
                <label for="paymentMethod">Payment Method:</label>
                <select id="paymentMethod">
                    <option value="">Select Method</option>
                    <option value="phonepay">PhonePe</option>
                    <option value="googlepay">Google Pay</option>
                    <option value="upi">UPI</option>
                </select>
            </div>
            <div id="paymentDetails" style="display:none;">
                <div class="modal-input-group">
                    <label for="paymentId">Enter UPI ID/Number:</label>
                    <input type="text" id="paymentId" placeholder="Enter your ID">
                </div>
                <div class="modal-input-group">
                    <label for="availableAmount">Available Amount:</label>
                    <input type="text" id="availableAmount" value="₹0" readonly>
                </div>
                <div class="modal-input-group">
                    <label for="withdrawAmount">Withdraw Amount:</label>
                    <input type="number" id="withdrawAmount" placeholder="Enter amount to withdraw [Minimum 100]">
                </div>
            </div>
            <div class="modal-actions">
                <button id="submitWithdrawal" disabled>Submit Withdrawal</button>
                <button id="cancelWithdrawal">Cancel</button>
            </div>
        </div>
    </div>

    <div id="paymentFormModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="paymentFormModalTitle" aria-describedby="paymentFormModalDescription" tabindex="-1">
        <div class="modal-content">
            <button class="close-button" aria-label="Close Payment Form Modal">&times;</button>
            <h3 id="paymentFormModalTitle">Complete Your Membership Payment</h3>
            <p id="paymentFormModalDescription" class="visually-hidden">Follow the instructions to make your membership payment and submit the details.</p>

            <div style="background-color: #fff3cd; border: 1px solid #ffeeba; border-radius: 5px; padding: 15px; margin-bottom: 20px; color: #856404;">
                <p style="font-weight: bold; margin-bottom: 10px;">Important Payment Instructions:</p>
                <p>
                    You need to click on the **Submit Payment Details** button after your manual payment, otherwise the admin will not receive your payment request.
                </p>
                <p style="margin-top: 10px;">
                    For faster course activation after a successful payment, please call the admin on:
                    <strong style="color: #007bff; font-size: 1.1em;">7731879173</strong>.
                </p>
            </div>
            <div class="instruction-box">
                To become a paid member, please transfer **₹1000** using one of the methods below. After payment, fill out the form and submit it for verification. Your access will be granted within 6 hours, If it is not granded, call on my number.
            </div>

            <h4>Your Payment Information:</h4>
            <div class="modal-input-group">
                <label for="paymentFullName">Full Name:</label>
                <input type="text" id="paymentFullName" placeholder="Enter your full name" readonly>
            </div>
            <div class="modal-input-group">
                <label for="paymentPhoneNumber">Phone Number:</label>
                <input type="text" id="paymentPhoneNumber" placeholder="Enter your phone number" readonly>
            </div>
            <div class="modal-input-group">
                <label for="paymentEmail">Email:</label>
                <input type="text" id="paymentEmail" placeholder="Enter your email" readonly>
            </div>

            <div class="modal-input-group">
                <label for="chosenPaymentMethod">Payment Method You Will Use:</label>
                <select id="chosenPaymentMethod">
                    <option value="">-- Select Payment Method --</option>
                    <option value="upi_id">UPI ID</option>
                    <option value="phonepe_number">PhonePe Number</option>
                    <option value="googlepay_number">Google Pay Number</option>
                    <option value="qr_code">QR Code</option>
                    <option value="bank_transfer">Bank Account Transfer</option>
                </select>
            </div>

            <div id="paymentDetailsDisplay" class="payment-display-section">
            </div>
            <div class="modal-input-group">
                <label for="transactionId">Transaction ID / Reference Number (Optional but Recommended):</label>
                <input type="text" id="transactionId" placeholder="e.g., UPI Ref ID, Bank Txn ID">
            </div>
            <div class="modal-input-group">
                <label for="screenshotUpload">Upload Screenshot (Optional):</label>
                <input type="file" id="screenshotUpload" accept="image/*">

<input type="checkbox" id="yes" required>
<label for="yes">Select this checkbox if you already made the payment</label>
<p>Without making the payment, you cannot submit this form.</p>

            </div>
            <div class="modal-actions">

                <button id="submitManualPayment">Submit Payment Details</button>
                <button id="cancelManualPayment">Cancel</button>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 Accessible World Tutorials</p>
        <a href="privacy.html" target="_blank">Privacy Policy</a>
        <a href="terms.html" target="_blank">Terms of Service</a>
        <a href="/contact.html" target="_blank">Contact Us</a>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import {
            getFirestore, doc, getDoc, collection,
            query, where, getDocs, updateDoc,
            addDoc, serverTimestamp, setDoc
        } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";


        const firebaseConfig = {
            apiKey: "AIzaSyBWtr_ZwK8hfA1We-yq9uUOjw5C6wXhx0k",
            authDomain: "accessibleworld-7f599.firebaseapp.com",
            projectId: "accessibleworld-7f599",
            storageBucket: "accessibleworld-7f599.appspot.com",
            messagingSenderId: "264437218598",
            appId: "1:264437218598:web:cae58c1e578c7b08b815e7",
            measurementId: "G-1QRWXYRZ76"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore(app);
        const storage = getStorage(app);

        // New profile elements
        const profileBtn = document.getElementById("profileBtn");
        const profileDetails = document.getElementById("profileDetails");

        const nameField = document.getElementById("user-name");
        const mobileField = document.getElementById("user-mobile");
        const emailField = document.getElementById("user-email");
        const paymentField = document.getElementById("user-payment-status");
        const initiatePaymentBtn = document.getElementById("initiatePaymentBtn");
        const logoutBtn = document.getElementById("logout");
        const referralLinkField = document.getElementById("referral-link");
        const copyLinkBtn = document.getElementById("copyLink");
        const toggleReferralBtn = document.getElementById("toggleReferral");
        const referralSection = document.getElementById("referralSection");
        const referralCountField = document.getElementById("referral-count");
        const earningsField = document.getElementById("total-earnings");
        const referralDetails = document.getElementById("referral-details");
        const withdrawBtn = document.getElementById("withdrawBtn");
        const statusMessage = document.getElementById("withdraw-status");
        const adminSection = document.getElementById("admin-section");
        const withdrawalList = document.getElementById("withdrawal-list");
        const paymentSection = document.getElementById("payment-section");
        const paymentReviewSection = document.getElementById("payment-review");
        const paymentRejectedSection = document.getElementById("payment-rejected");
        const courseAccessSection = document.getElementById("course-access");
        const coursesBtn = document.getElementById("coursesBtn");
        const manualPaymentList = document.getElementById("manual-payment-list");

        // New elements for withdrawal summary
        const totalWithdrawnDisplay = document.getElementById("total-withdrawn-display");
        const availableBalanceDisplay = document.getElementById("available-balance-display");

        // Withdrawal Modal elements
        const withdrawModal = document.getElementById("withdrawModal");
        const withdrawModalCloseButton = withdrawModal.querySelector(".close-button");
        const withdrawModalTitle = document.getElementById("withdrawModalTitle");
        const totalAmountModal = document.getElementById("totalAmount");
        const paymentMethodDropdown = document.getElementById("paymentMethod");
        const paymentDetailsDiv = document.getElementById("paymentDetails");
        const paymentIdInput = document.getElementById("paymentId");
        const availableAmountInput = document.getElementById("availableAmount");
        const withdrawAmountInput = document.getElementById("withdrawAmount");
        const submitWithdrawalButton = document.getElementById("submitWithdrawal");
        const cancelWithdrawalButton = document.getElementById("cancelWithdrawal");

        // New Payment Form Modal elements
        const paymentFormModal = document.getElementById("paymentFormModal");
        const paymentFormModalCloseButton = paymentFormModal.querySelector(".close-button");
        const paymentFormModalTitle = document.getElementById("paymentFormModalTitle");
        const paymentFullNameInput = document.getElementById("paymentFullName");
        const paymentPhoneNumberInput = document.getElementById("paymentPhoneNumber");
        const paymentEmailInput = document.getElementById("paymentEmail");
        const chosenPaymentMethodSelect = document.getElementById("chosenPaymentMethod");
        const paymentDetailsDisplay = document.getElementById("paymentDetailsDisplay");
        const transactionIdInput = document.getElementById("transactionId");
        const screenshotUploadInput = document.getElementById("screenshotUpload");
        const submitManualPaymentBtn = document.getElementById("submitManualPayment");
        const cancelManualPaymentBtn = document.getElementById("cancelManualPayment");

        let currentUserId, currentUserName, currentUserMobile, currentUserEmail, currentEarnings = 0;
        let lastFocusedElement = null; // To store the element that opened the modal

        // --- Our Payment Details (Centralized for easy editing) ---
        const OUR_PAYMENT_DETAILS = {
            upi_id: {
                label: "Our UPI ID",
                value: "7702675618@ybl", // <<< REPLACE THIS
                instructions: "Use any UPI app (Google Pay, PhonePe, Paytm, etc.) to send ₹1000 to this UPI ID."
            },
            phonepe_number: {
                label: "Our PhonePe Number",
                value: "7702675618", // <<< REPLACE THIS
                instructions: "Open PhonePe, go to 'To Mobile Number' and send ₹1000 to this number. The name will display as Ravva Gowri."
            },
            googlepay_number: {
                label: "Our Google Pay Number",
                value: "7702675618", // <<< REPLACE THIS (Can be same as PhonePe or different)
                instructions: "Open Google Pay, go to 'Pay phone number' and send ₹1000 to this number."
            },
            qr_code: {
                label: "Scan Our QR Code",
                imageUrl: "qr_scanner.png", // <<< REPLACE THIS with your actual QR code image path
                instructions: "If scanner is not working, kindly use other payment methods. We will resolve this problem shortly. "
            },
            bank_transfer: {
                label: "Our Bank Account Details",
                accountName: "Pentakota Raviteja",    // <<< REPLACE THIS
                accountNumber: "35838062455", // <<< REPLACE THIS
                ifscCode: "SBIN0021121",           // <<< REPLACE THIS
                instructions: "Transfer ₹1000 directly to our bank account using NEFT/IMPS/RTGS. Please use your registered email/phone in the transaction remarks if possible."
            }
        };

        // --- Utility Functions ---

        // Function to open any modal
        function openModal(modalElement) {
            lastFocusedElement = document.activeElement; // Store the currently focused element
            modalElement.style.display = 'block';
            modalElement.setAttribute('aria-hidden', 'false');
            document.body.classList.add('modal-open');
            modalElement.focus(); // Focus the modal itself for screen readers
            trapFocus(modalElement); // Start trapping focus
        }

        // Function to close any modal
        function closeModal(modalElement) {
            modalElement.style.display = 'none';
            modalElement.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('modal-open');
            if (lastFocusedElement) {
                lastFocusedElement.focus(); // Return focus to the element that opened the modal
                lastFocusedElement = null; // Clear the stored element
            }
        }

        // Function to trap focus inside a modal
        function trapFocus(modalElement) {
            const focusableElements = modalElement.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            const firstFocusableElement = focusableElements[0];
            const lastFocusableElement = focusableElements[focusableElements.length - 1];

            modalElement.addEventListener('keydown', function(e) {
                const isTabPressed = (e.key === 'Tab');

                if (!isTabPressed) {
                    return;
                }

                if (e.shiftKey) { // if shift key and tab key are pressed
                    if (document.activeElement === firstFocusableElement) {
                        lastFocusableElement.focus(); // add focus to the last focusable element
                        e.preventDefault();
                    }
                } else { // if tab key is pressed
                    if (document.activeElement === lastFocusableElement) {
                        firstFocusableElement.focus(); // add focus to the first focusable element
                        e.preventDefault();
                    }
                }
            });
        }


        async function fetchReferralLevels(uid, level=1, max=5) {
            if(level > max) return [];
            const q = query(collection(db,"users"), where("referredBy","==",uid));
            const snap = await getDocs(q);
            let out=[];
            for(const ds of snap.docs) {
                const d=ds.data();
                // Only consider paid referrals for earnings calculation
                const earning = calculateReferralEarning(level, d.paymentStatus);
                out.push({ level, fullName:d.fullName, mobile:d.phoneNumber, email:d.email, paymentStatus:d.paymentStatus, uid:ds.id, earning }); // Used phoneNumber
                out = out.concat(await fetchReferralLevels(ds.id, level + 1, max));
            }
            return out;
        }

        function calculateReferralEarning(level, paymentStatus) {
            if (paymentStatus !== "Paid") return 0;
            if (level === 1) return 240;
            if (level === 2) return 150;
            if (level === 3) return 110;
            if (level === 4) return 60;
            if (level === 5) return 40;
            return 0;
        }

        async function fetchWithdrawalsForAdmin() {
            withdrawalList.innerHTML = "";
            const q = query(collection(db, "withdrawals"), where("status", "==", "Pending"));
            const snap = await getDocs(q);
            if (snap.empty) {
                withdrawalList.innerHTML = "<p>No pending withdrawals.</p>";
                return;
            }
            snap.forEach(docSnap => {
                const data = docSnap.data();
                const card = document.createElement("div");
                card.className = "withdrawal-card";
                card.innerHTML = `
                    <p><strong>Name:</strong> ${data.fullName}</p>
                    <p><strong>Email:</strong> ${data.email}</p>
                    <p><strong>Phone:</strong> ${data.phone}</p>
                    <p><strong>Amount:</strong> ₹${data.amount}</p>
                    <p><strong>Method:</strong> ${data.paymentMethod}</p>
                    <p><strong>ID/Number:</strong> ${data.paymentId}</p>
                    <p><strong>Date:</strong> ${data.requestedAt?.toDate().toLocaleString() || "N/A"}</p>
                    <p><strong>Status:</strong> ${data.status}</p>
                    <button data-id="${docSnap.id}" class="approve-withdrawal-btn" style="background:#28a745; margin-right:5px;">Approve</button>
                    <button data-id="${docSnap.id}" class="reject-withdrawal-btn" style="background:#dc3545;">Reject</button>
                `;
                withdrawalList.appendChild(card);
            });

            withdrawalList.querySelectorAll('.approve-withdrawal-btn').forEach(button => {
                button.onclick = async (event) => {
                    const withdrawalId = event.target.dataset.id;
                    try {
                        const withdrawalDocRef = doc(db, "withdrawals", withdrawalId);
                        const withdrawalDoc = await getDoc(withdrawalDocRef);
                        if (!withdrawalDoc.exists()) {
                            alert(`Withdrawal ${withdrawalId} not found.`);
                            return;
                        }
                        const data = withdrawalDoc.data();
                        await updateDoc(withdrawalDocRef, { status: "Approved" });
                        alert(`Withdrawal ${withdrawalId} approved!`);
                        fetchWithdrawalsForAdmin(); // Refresh the list
                    } catch (error) {
                        console.error("Error approving withdrawal:", error);
                        alert("Error approving withdrawal. Check console for details.");
                    }
                };
            });

            withdrawalList.querySelectorAll('.reject-withdrawal-btn').forEach(button => {
                button.onclick = async (event) => {
                    const withdrawalId = event.target.dataset.id;
                    try {
                        const withdrawalDocRef = doc(db, "withdrawals", withdrawalId);
                        const withdrawalDocSnap = await getDoc(withdrawalDocRef);

                        if (!withdrawalDocSnap.exists()) {
                            alert(`Withdrawal with ID ${withdrawalId} not found.`);
                            return;
                        }

                        const withdrawalData = withdrawalDocSnap.data();
                        const userId = withdrawalData.userId;
                        const amount = withdrawalData.amount;

                        // Update withdrawal status to Rejected
                        await updateDoc(withdrawalDocRef, { status: "Rejected" });
                        alert(`Withdrawal ${withdrawalId} rejected!`);
                        fetchWithdrawalsForAdmin(); // Refresh the list

                        // If rejected, refund the amount to the user's available balance
                        if (userId && amount) {
                            const userDocRef = doc(db, "users", userId);
                            const userDocSnap = await getDoc(userDocRef);

                            if (userDocSnap.exists()) {
                                const userData = userDocSnap.data();
                                const currentAvailableBalance = userData.availableBalance || 0;
                                const newAvailableBalance = currentAvailableBalance + amount;

                                await updateDoc(userDocRef, {
                                    availableBalance: newAvailableBalance
                                });
                                console.log(`User ${userId}'s availableBalance updated by ${amount} due to rejection.`);
                            } else {
                                console.error(`User document not found for ID: ${userId}`);
                            }
                        }
                    } catch (error) {
                        console.error("Error rejecting withdrawal:", error);
                        alert("Error rejecting withdrawal. Check console for details. (Possible Firebase Security Rule issue)");
                    }
                };
            });
        }

        async function fetchManualPaymentsForAdmin() {
            manualPaymentList.innerHTML = "";
            const q = query(collection(db, "manualPayments"), where("status", "==", "Pending"));
            const snap = await getDocs(q);
            if (snap.empty) {
                manualPaymentList.innerHTML = "<p>No pending manual payments.</p>";
                return;
            }
            snap.forEach(docSnap => {
                const data = docSnap.data();
                const card = document.createElement("div");
                card.className = "withdrawal-card"; // Reusing style for consistency
                card.innerHTML = `
                    <p><strong>User:</strong> ${data.fullName} (${data.email})</p>
                    <p><strong>Phone:</strong> ${data.phone}</p>
<p><strong>Amount:</strong> ₹1000</p>
                    <p><strong>Method Used:</strong> ${data.chosenPaymentMethod}</p>
                    <p><strong>Transaction ID:</strong> ${data.transactionId || 'N/A'}</p>
                    ${data.screenshotUrl ? `<p><strong>Screenshot:</strong> <a href="${data.screenshotUrl}" target="_blank">View Screenshot</a></p>` : ''}
                    <p><strong>Submitted At:</strong> ${data.submittedAt?.toDate().toLocaleString() || "N/A"}</p>
                    <button data-userid="${data.userId}" data-paymentid="${docSnap.id}" class="approve-payment-btn" style="background:#28a745; margin-right:5px;">Approve Payment</button>
                    <button data-userid="${data.userId}" data-paymentid="${docSnap.id}" class="reject-payment-btn" style="background:#dc3545;">Reject Payment</button>
                `;
                manualPaymentList.appendChild(card);
            });

            manualPaymentList.querySelectorAll('.approve-payment-btn').forEach(button => {
                button.onclick = async (event) => {
                    const userId = event.target.dataset.userid;
                    const paymentId = event.target.dataset.paymentid;

                    try {
                        // 1. Update user's payment status to "Paid"
                        await updateDoc(doc(db, "users", userId), { paymentStatus: "Paid" });
                        // 2. Update the manual payment record to "Approved"
                        await updateDoc(doc(db, "manualPayments", paymentId), { status: "Approved" });

                        alert(`Payment for user ${userId} approved!`);
                        fetchManualPaymentsForAdmin(); // Refresh the list
                        // Also, re-fetch user data for the specific user if they are currently logged in to update their dashboard instantly
                        if (userId === currentUserId) {
                            await fetchUserDataAndDisplay(userId);
                        }
                    } catch (error) {
                        console.error("Error approving payment:", error);
                        alert("Error approving payment. Check console for details. (Possible Firebase Security Rule issue)");
                    }
                };
            });

            manualPaymentList.querySelectorAll('.reject-payment-btn').forEach(button => {
                button.onclick = async (event) => {
                    const userId = event.target.dataset.userid;
                    const paymentId = event.target.dataset.paymentid;

                    try {
                        // 1. Update manual payment record status to "Rejected"
                        await updateDoc(doc(db, "manualPayments", paymentId), { status: "Rejected" });
                        // 2. Update user's payment status to "Rejected"
                        await updateDoc(doc(db, "users", userId), { paymentStatus: "Rejected" });

                        alert(`Payment for user ${userId} rejected! User status updated to 'Rejected'.`);
                        fetchManualPaymentsForAdmin(); // Refresh the list
                        if (userId === currentUserId) {
                            await fetchUserDataAndDisplay(userId); // Refresh user's dashboard
                        }
                    } catch (error) {
                        console.error("Error rejecting payment:", error);
                        alert("Error rejecting payment. Check console for details. (Possible Firebase Security Rule issue)");
                    }
                };
            });
        }


        // --- Authentication and Data Fetching ---

        async function fetchUserDataAndDisplay(uid) {
            const userDoc = await getDoc(doc(db, "users", uid));
            if (!userDoc.exists()) {
                console.error("No user data found for UID:", uid);
                return;
            }
            const userData = userDoc.data();
            currentUserName = userData.fullName || "";
            currentUserMobile = userData.mobile || ""; // Correctly assigned from 'phoneNumber'
            currentUserEmail = userData.email || "";

            nameField.textContent = currentUserName;
            mobileField.textContent = currentUserMobile; // Displaying in profile
            emailField.textContent = currentUserEmail;
            paymentField.textContent = userData.paymentStatus || "Pending";

            referralLinkField.textContent = `${location.origin}/register.html?ref=${uid}`;

            // Reset visibility of payment-related sections
            paymentSection.style.display = "block"; // Show initiate payment button by default
            paymentReviewSection.style.display = "none";
            paymentRejectedSection.style.display = "none";
            courseAccessSection.style.display = "none";

            // Logic to show/hide sections based on paymentStatus
            if (userData.paymentStatus === "Paid") {
                paymentSection.style.display = "none"; // Hide initiate payment button
                courseAccessSection.style.display = "block"; // Show course access
            } else if (userData.paymentStatus === "Pending") {
                paymentSection.style.display = "none"; // Hide initiate payment button
                paymentReviewSection.style.display = "block"; // Show payment under review message
            } else if (userData.paymentStatus === "Rejected") {
                paymentSection.style.display = "block"; // Allow user to initiate payment again
                paymentRejectedSection.style.display = "block"; // Show rejected message
            }
            // If paymentStatus is null/undefined or any other status, default behavior (show initiatePaymentBtn) will remain.


            const refs = await fetchReferralLevels(uid);
            referralCountField.textContent = refs.length;
            referralDetails.innerHTML = "";
            let calculatedReferralEarnings = 0;
            refs.forEach(r => {
                calculatedReferralEarnings += r.earning; // Use pre-calculated earning from fetchReferralLevels
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${r.level}</td>
                    <td>${r.fullName}</td>
                    <td>${r.mobile}</td>
                    <td>${r.email}</td>
                    <td>${r.paymentStatus}</td>
                    <td>₹${r.earning}</td>
                `;
                referralDetails.appendChild(tr);
            });
            earningsField.textContent = `₹${calculatedReferralEarnings}`;
            currentEarnings = calculatedReferralEarnings; // Update global variable

            // Fetch withdrawal summary
            const withdrawalSummaryRef = doc(db, "userSummaries", uid);
            const withdrawalSummarySnap = await getDoc(withdrawalSummaryRef);
            let totalWithdrawn = 0;
            let availableBalance = 0;

            if (withdrawalSummarySnap.exists()) {
                const summaryData = withdrawalSummarySnap.data();
                totalWithdrawn = summaryData.totalWithdrawn || 0;
                availableBalance = summaryData.availableBalance || 0;
            } else {
                // If summary doesn't exist, calculate available balance based on current earnings and approved withdrawals
                const approvedWithdrawalsQuery = query(collection(db, "withdrawals"),
                                                    where("userId", "==", uid),
                                                    where("status", "==", "Approved"));
                const approvedWithdrawalsSnap = await getDocs(approvedWithdrawalsQuery);
                let sumApprovedWithdrawals = 0;
                approvedWithdrawalsSnap.forEach(doc => {
                    sumApprovedWithdrawals += doc.data().amount || 0;
                });
                totalWithdrawn = sumApprovedWithdrawals;
                availableBalance = calculatedReferralEarnings - totalWithdrawn;
            }

            totalWithdrawnDisplay.textContent = `₹${totalWithdrawn}`;
            availableBalanceDisplay.textContent = `₹${availableBalance}`;
            availableAmountInput.value = `₹${availableBalance}`; // Update modal field too
            withdrawAmountInput.max = availableBalance; // Set max withdrawal amount

            // Enable/disable withdraw button based on available balance
            if (availableBalance >= 100) {
                withdrawBtn.disabled = false;
                statusMessage.textContent = "";
            } else {
                withdrawBtn.disabled = true;
                statusMessage.textContent = "Minimum withdrawal amount is ₹100.";
                statusMessage.style.color = "red";
            }
        }


        // --- Event Listeners ---

        profileBtn.addEventListener('click', () => {
            const isExpanded = profileBtn.getAttribute('aria-expanded') === 'true';
            profileBtn.setAttribute('aria-expanded', !isExpanded);
            profileDetails.style.display = isExpanded ? 'none' : 'block';
        });

        logoutBtn.onclick = () => signOut(auth).then(() => location.href = "login.html");

        copyLinkBtn.onclick = () => {
            const link = referralLinkField.textContent;
            navigator.clipboard.writeText(link).then(() => {
                alert("Referral link copied to clipboard!");
            }).catch(err => {
                console.error("Failed to copy: ", err);
            });
        };

        toggleReferralBtn.addEventListener('click', () => {
            const isHidden = referralSection.style.display === 'none';
            referralSection.style.display = isHidden ? 'block' : 'none';
            toggleReferralBtn.setAttribute('aria-expanded', isHidden);
        });

        withdrawBtn.onclick = () => {
            openModal(withdrawModal);
        };

        withdrawModalCloseButton.onclick = () => closeModal(withdrawModal);
        cancelWithdrawalButton.onclick = () => closeModal(withdrawModal);

        // Close modals on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (withdrawModal.style.display === 'block') {
                    closeModal(withdrawModal);
                }
                if (paymentFormModal.style.display === 'block') {
                    closeModal(paymentFormModal);
                }
            }
        });


        paymentMethodDropdown.addEventListener('change', function() {
            if (this.value) {
                paymentDetailsDiv.style.display = 'block';
            } else {
                paymentDetailsDiv.style.display = 'none';
            }
        });

        withdrawAmountInput.addEventListener('input', function() {
            const requestedAmount = parseFloat(this.value);
            const available = parseFloat(availableBalanceDisplay.textContent.replace('₹', ''));
            if (requestedAmount >= 100 && requestedAmount <= available) {
                submitWithdrawalButton.disabled = false;
            } else {
                submitWithdrawalButton.disabled = true;
            }
        });

        submitWithdrawalButton.onclick = async () => {
            const amount = parseFloat(withdrawAmountInput.value);
            const method = paymentMethodDropdown.value;
            const paymentId = paymentIdInput.value.trim();
            const availableBalance = parseFloat(availableBalanceDisplay.textContent.replace('₹', ''));

            if (!amount || amount < 100 || amount > availableBalance) {
                alert("Please enter a valid amount between ₹100 and your available balance.");
                return;
            }
            if (!method) {
                alert("Please select a payment method.");
                return;
            }
            if (!paymentId) {
                alert("Please enter your UPI ID/Number.");
                return;
            }

            try {
                // Deduct from user's available balance in users collection
                const userDocRef = doc(db, "users", currentUserId);
                await updateDoc(userDocRef, {
                    availableBalance: availableBalance - amount
                });

                // Record the withdrawal request
                await addDoc(collection(db, "withdrawals"), {
                    userId: currentUserId,
                    fullName: currentUserName,
                    email: currentUserEmail,
                    phone: currentUserMobile, // Assuming 'phone' for withdrawal data
                    amount: amount,
                    paymentMethod: method,
                    paymentId: paymentId,
                    status: "Pending",
                    requestedAt: serverTimestamp()
                });

                // Update total withdrawn in userSummaries (or create if not exists)
                const userSummaryRef = doc(db, "userSummaries", currentUserId);
                const userSummarySnap = await getDoc(userSummaryRef);
                if (userSummarySnap.exists()) {
                    await updateDoc(userSummaryRef, {
                        totalWithdrawn: (userSummarySnap.data().totalWithdrawn || 0) + amount,
                        availableBalance: (userSummarySnap.data().availableBalance || 0) - amount
                    });
                } else {
                    await setDoc(userSummaryRef, { // Use setDoc to create if it doesn't exist
                        totalWithdrawn: amount,
                        availableBalance: availableBalance - amount,
                        userId: currentUserId
                    });
                }

                alert("Withdrawal request submitted successfully!");
                closeModal(withdrawModal);
                await fetchUserDataAndDisplay(currentUserId); // Refresh dashboard
                // If admin, also refresh admin withdrawal list if admin (This block will be called by onAuthStateChanged if the user is admin)
                // if (currentUserId && userDoc.data().role === "admin") {
                //     fetchWithdrawalsForAdmin();
                // }

            } catch (error) {
                console.error("Error submitting withdrawal:", error);
                alert("Failed to submit withdrawal request.");
            }
        };

        // Payment form modal handling
        initiatePaymentBtn.addEventListener('click', async () => {
            // Ensure user data is available
            if (!currentUserId) {
                alert("User not logged in or data not loaded.");
                return;
            }

            paymentFullNameInput.value = currentUserName;
            paymentPhoneNumberInput.value = currentUserMobile; // Correctly populated
            paymentEmailInput.value = currentUserEmail;

            // Optionally, check user payment status here again to prevent opening if already paid/pending
            const userDocCurrent = await getDoc(doc(db, "users", currentUserId));
            if (userDocCurrent.exists()) {
                const status = userDocCurrent.data().paymentStatus;
                if (status === "Paid") {
                     alert("You are already a paid member.");
                     return;
                }
                if (status === "Pending") {
                    alert("Your previous payment is still under review. Please wait for verification.");
                    return;
                }
            }

            openModal(paymentFormModal);
        });

        paymentFormModalCloseButton.onclick = () => closeModal(paymentFormModal);
        cancelManualPaymentBtn.onclick = () => closeModal(paymentFormModal);

        chosenPaymentMethodSelect.addEventListener('change', () => {
            const method = chosenPaymentMethodSelect.value;
            const detailsDiv = paymentDetailsDisplay;
            detailsDiv.innerHTML = '';
            detailsDiv.style.display = 'none';

            if (method && OUR_PAYMENT_DETAILS[method]) {
                const methodDetails = OUR_PAYMENT_DETAILS[method];
                let html = `<p style="font-weight: bold;">${methodDetails.label}:</p>`;
                if (methodDetails.value) {
                    html += `<p><strong>${methodDetails.value}</strong></p>`;
                }
                if (methodDetails.accountName) {
                    html += `<p><strong>Account Name:</strong> ${methodDetails.accountName}</p>`;
                }
                if (methodDetails.accountNumber) {
                    html += `<p><strong>Account Number:</strong> ${methodDetails.accountNumber}</p>`;
                }
                if (methodDetails.ifscCode) {
                    html += `<p><strong>IFSC Code:</strong> ${methodDetails.ifscCode}</p>`;
                }
                if (methodDetails.imageUrl) {
                    html += `<img src="${methodDetails.imageUrl}" alt="${methodDetails.label} QR Code">`;
                }
                html += `<p style="font-style: italic; margin-top: 10px;">${methodDetails.instructions}</p>`;
                detailsDiv.innerHTML = html;
                detailsDiv.style.display = 'block';
            }
        });

        submitManualPaymentBtn.addEventListener('click', async () => {
            const selectedMethod = chosenPaymentMethodSelect.value;
            const transactionId = transactionIdInput.value.trim();
            const screenshotFile = screenshotUploadInput.files[0];
            const amount = 1000; // Fixed membership amount
    const checkbox = document.getElementById('yes');
    if (!checkbox.checked) {
      alert("Please confirm that you have made the payment by selecting the checkbox.");
      event.preventDefault(); // Prevent form or modal submission
      return false;
    }
            if (!selectedMethod) {
                alert("Please select a payment method you used.");
                return;
            }

            let screenshotUrl = '';
            if (screenshotFile) {
                const storageRef = ref(storage, `screenshots/${currentUserId}_${Date.now()}_${screenshotFile.name}`);
                try {
                    const uploadTask = await uploadBytes(storageRef, screenshotFile);
                    screenshotUrl = await getDownloadURL(uploadTask.ref);
                    console.log("Screenshot uploaded:", screenshotUrl);
                } catch (uploadError) {
                    console.error("Error uploading screenshot:", uploadError);
                    alert("Failed to upload screenshot. Please try again or proceed without it.");
                    // Decide if you want to stop here or allow submission without screenshot
                    screenshotUrl = ''; // Clear URL if upload fails
                }
            }

            try {
                // Update user's paymentStatus to "Pending"
                const userDocRef = doc(db, "users", currentUserId);
                await updateDoc(userDocRef, {
                    paymentStatus: "Pending"
                });
                console.log("User payment status updated to Pending in Firestore.");

                // Add manual payment request to 'manualPayments' collection
                await addDoc(collection(db, "manualPayments"), {
                    userId: currentUserId,
                    fullName: currentUserName,
                    email: currentUserEmail,
                    registeredPhone: currentUserMobile, // Saving user's registered phone
                    amount: amount,
                    chosenPaymentMethod: selectedMethod,
                    transactionId: transactionId,
                    screenshotUrl: screenshotUrl,
                    status: "Pending", // Status for admin review
                    submittedAt: serverTimestamp()
                });
                console.log("Manual payment request added to Firestore.");

                alert("Payment details submitted successfully! Your membership will be activated after verification.");
                closeModal(paymentFormModal);
                await fetchUserDataAndDisplay(currentUserId); // Refresh dashboard to show pending status
                // If admin, also refresh admin's manual payment list (This block will be called by onAuthStateChanged if the user is admin)
                // if (currentUserId && (await getDoc(doc(db, "users", currentUserId))).data().role === "admin") {
                //     fetchManualPaymentsForAdmin();
                // }

            } catch (error) {
                console.error("Error submitting manual payment:", error);
                alert("Failed to submit payment details. Please try again. (Possible Firebase Security Rule issue)");
            }
        });

        // --- Initial Load ---
        onAuthStateChanged(auth, async user => {
            if (user) {
                currentUserId = user.uid;
                await fetchUserDataAndDisplay(user.uid);

                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists() && userDoc.data()?.role === "admin") {
                    adminSection.style.display = "block";
                    fetchWithdrawalsForAdmin();
                    fetchManualPaymentsForAdmin();
                }
            } else {
                location.href = "login.html";
            }
        });
    </script>
</body>
</html>