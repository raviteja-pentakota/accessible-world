<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard | Accessible Learn and Win</title>
  <style>
    body { font-family: Arial, sans-serif; padding:20px; background:#f0f2f5; }
    .card { background:#fff; border-radius:8px; padding:20px; margin-bottom:20px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    button { padding:10px 20px; border:none; background:#007bff; color:#fff; border-radius:4px; cursor:pointer; }
    button:hover { background:#0056b3; }
    ul { padding-left:20px; }
    #referralSection { display:none; }
    #withdraw-status { margin-top:10px; color:green; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Welcome to Accessible Learn and Win</h2>
    <p><strong>Name:</strong> <span id="user-name"></span></p>
    <p><strong>Mobile:</strong> <span id="user-mobile"></span></p>
    <p><strong>Email:</strong> <span id="user-email"></span></p>
    <p><strong>Payment Status:</strong> <span id="user-payment-status"></span></p>
    <button id="payBtn">Pay ₹1000 Membership</button>
    <button id="logout" style="float:right;background:#dc3545">Logout</button>
  </div>

  <div class="card">
    <h3>Your Referral Link</h3>
    <p><span id="referral-link"></span></p>
    <button id="copyLink">Copy Link</button>
  </div>

  <div class="card">
    <button id="toggleReferral">Show/Hide Referral Details</button>
    <div id="referralSection">
      <h3>Referral Overview</h3>
      <p>Total Referrals: <span id="referral-count">0</span></p>
      <p>Total Earnings: <span id="total-earnings">₹0</span></p>
      <ul id="referral-details"></ul>
    </div>
  </div>

  <div class="card">
    <h3>Withdraw Earnings</h3>
    <button id="withdrawBtn">Request Withdrawal</button>
    <p id="withdraw-status"></p>
  </div>

  <!-- Razorpay -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <!-- Firebase + App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, collection,
      query, where, getDocs, updateDoc,
      addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    // -- Your Firebase config --
    const firebaseConfig = {
      apiKey: "AIzaSyBWtr_ZwK8hfA1We-yq9uUOjw5C6wXhx0k",
      authDomain: "accessibleworld-7f599.firebaseapp.com",
      projectId: "accessibleworld-7f599",
      storageBucket: "accessibleworld-7f599.appspot.com",
      messagingSenderId: "264437218598",
      appId: "1:264437218598:web:cae58c1e578c7b08b815e7",
      measurementId: "G-1QRWXYRZ76"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore(app);

    // UI refs
    const nameField = document.getElementById("user-name");
    const mobileField = document.getElementById("user-mobile");
    const emailField = document.getElementById("user-email");
    const paymentField = document.getElementById("user-payment-status");
    const payBtn = document.getElementById("payBtn");
    const logoutBtn = document.getElementById("logout");
    const referralLinkField = document.getElementById("referral-link");
    const copyLinkBtn = document.getElementById("copyLink");
    const toggleReferralBtn = document.getElementById("toggleReferral");
    const referralSection = document.getElementById("referralSection");
    const referralCountField = document.getElementById("referral-count");
    const earningsField = document.getElementById("total-earnings");
    const referralDetails = document.getElementById("referral-details");
    const withdrawBtn = document.getElementById("withdrawBtn");
    const statusMessage = document.getElementById("withdraw-status");

    let currentUserId, currentUserName, currentUserMobile, currentUserEmail, currentEarnings=0;

    // Recursively fetch referrals
    async function fetchReferralLevels(uid, level=1, max=5) {
      if(level>max) return [];
      const q = query(collection(db,"users"), where("referredBy","==",uid));
      const snap = await getDocs(q);
      let out=[];
      for(const ds of snap.docs) {
        const d=ds.data();
        out.push({ level, fullName:d.fullName, email:d.email, paymentStatus:d.paymentStatus, uid:ds.id });
        out = out.concat(await fetchReferralLevels(ds.id, level+1, max));
      }
      return out;
    }

    // Auth listener
    onAuthStateChanged(auth, async user=> {
      if(!user) return location.href="index.html";
      currentUserId = user.uid;
      currentUserEmail = user.email;
      // get profile
      const u=await getDoc(doc(db,"users",user.uid));
      if(!u.exists()) return alert("No user data!");
      const d=u.data();
      currentUserName=d.fullName||"";
      currentUserMobile=d.mobile||"";
      nameField.textContent = currentUserName;
      mobileField.textContent = currentUserMobile;
      emailField.textContent = currentUserEmail;
      paymentField.textContent = d.paymentStatus||"Pending";

      // Referral link
      referralLinkField.textContent = `${location.origin}/register.html?ref=${user.uid}`;

      // Referrals
      const refs = await fetchReferralLevels(user.uid);
      referralCountField.textContent = refs.length;
      let total=0;
      referralDetails.innerHTML="";
      refs.forEach(r=>{
        const inc = r.paymentStatus==="Paid"
          ? (r.level===1?280:r.level===2?180:r.level===3?140:100)
          : 0;
        total+=inc;
        const li=document.createElement("li");
        li.textContent = `Level ${r.level} – ${r.fullName} (${r.email}): ${r.paymentStatus}, ₹${inc}`;
        referralDetails.append(li);
      });
      earningsField.textContent = `₹${total}`;
      currentEarnings=total;
    });

    // UI handlers
    logoutBtn.onclick = ()=> signOut(auth).then(()=>location.href="index.html");
    copyLinkBtn.onclick = ()=> { navigator.clipboard.writeText(referralLinkField.textContent); alert("Copied!"); }
    toggleReferralBtn.onclick = ()=> referralSection.style.display = referralSection.style.display==="none"?"block":"none";

    // Razorpay
    payBtn.onclick = ()=>{
      new Razorpay({
        key:"rzp_test_65YRKaINc6MqXg",
        amount:100000, currency:"INR",
        name:"Accessible Learn and Win",
        description:"Membership Fee",
        prefill:{ name:currentUserName, email:currentUserEmail, contact:currentUserMobile },
        theme:{ color:"#007bff" },
        handler: async resp=>{
          alert("Paid: "+resp.razorpay_payment_id);
          await updateDoc(doc(db,"users",currentUserId),{ paymentStatus:"Paid" });
          paymentField.textContent="Paid";
        }
      }).open();
    };

    // Withdraw
    withdrawBtn.onclick = async ()=>{
      if(currentEarnings<100) return statusMessage.textContent="Min ₹100 to withdraw";
      try {
        await addDoc(collection(db,"withdrawals"), {
          userId:currentUserId,
          fullName:currentUserName,
          email:currentUserEmail,
          phone:currentUserMobile,
          amount:currentEarnings,
          requestedAt:serverTimestamp(),
          status:"Pending"
        });
        statusMessage.textContent="Request submitted!";
      } catch(e){
        console.error(e);
        statusMessage.textContent="Could not submit";
      }
    };
  </script>
</body>
</html>
