<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Dashboard | Accessible World Tutorials</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f2f5;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .card {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        button {
            padding: 10px 20px;
            border: none;
            background: #007bff;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        ul {
            padding-left: 20px;
        }
        #referralSection {
            display: none;
        }
        #withdraw-status {
            margin-top: 10px;
            color: green;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th,
        td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f9f9f9;
        }
        .admin-section {
            background: #fffbe6;
            padding: 20px;
            margin-top: 30px;
            border: 1px solid #ffe58f;
            border-radius: 8px;
        }
        .withdrawal-card {
            border-bottom: 1px solid #ddd;
            padding: 10px 0;
        }
        .withdrawal-card:last-child {
            border-bottom: none;
        }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 2; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0, 0, 0, 0.4); /* Black w/ opacity */
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto; /* Adjusted margin for slightly higher position */
            padding: 20px;
            border: 1px solid #888;
            width: 90%; /* Increased width for better mobile view */
            max-width: 600px; /* Max width for larger screens */
            border-radius: 8px;
            position: relative;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
        }

        .modal-input-group {
            margin-bottom: 15px;
        }

        .modal-input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .modal-input-group select,
        .modal-input-group input[type="text"],
        .modal-input-group input[type="number"],
        .modal-input-group input[type="file"] {
            width: calc(100% - 12px);
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .modal-input-group textarea {
            width: calc(100% - 12px);
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            resize: vertical;
        }

        .modal-actions {
            text-align: right;
        }

        .modal-actions button {
            margin-left: 10px;
        }

        /* Footer Styles */
        footer {
            background: #333;
            color: #fff;
            padding: 10px 20px;
            text-align: center;
            margin-top: auto; /* Push footer to the bottom */
            border-radius: 0 0 8px 8px;
        }

        footer a {
            color: #fff;
            text-decoration: none;
            margin: 0 10px;
        }

        footer a:hover {
            text-decoration: underline;
        }

        /* Accessibility helper class to visually hide but keep accessible */
        .visually-hidden {
            position: absolute !important;
            height: 1px;
            width: 1px;
            overflow: hidden;
            clip: rect(1px, 1px, 1px, 1px);
            white-space: nowrap;
        }

        /* Styles for blurring main content when modal is open */
        body.modal-open > *:not(.modal) {
            filter: blur(3px); /* Slightly less blur for better performance */
            pointer-events: none;
            user-select: none;
        }

        /* Styles for profile dropdown */
        .profile-container {
            position: relative;
            display: inline-block;
            float: right; /* To align it to the right */
        }

        .profile-dropdown {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 1;
            right: 0; /* Align dropdown to the right of the button */
            border-radius: 4px;
            padding: 10px;
            top: 40px; /* Position below the button */
        }

        .profile-dropdown p {
            margin: 5px 0;
            padding: 0;
            font-size: 14px;
        }

        .profile-dropdown button {
            width: 100%;
            margin-top: 10px;
        }

        /* Payment details section in modal (original, less specific) */
        #paymentMethodDetails {
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        #paymentMethodDetails div {
            margin-bottom: 10px;
        }

        /* Corrected CSS for image within paymentDetailsDisplay (for QR code) */
        #paymentDetailsDisplay img {
            max-width: 200px; /* Set a maximum width for the image */
            width: 100%; /* Make it responsive within its container */
            height: auto; /* Maintain aspect ratio */
            display: block; /* Make it a block-level element */
            margin: 20px auto; /* Center horizontally with more vertical spacing */
            border: 1px solid #ddd; /* Slightly softer border */
            padding: 8px; /* Slightly more padding */
            box-sizing: border-box;
            border-radius: 4px; /* Slightly rounded corners */

            /* Image rendering for sharp display */
            image-rendering: auto;
            image-rendering: crisp-edges;
            image-rendering: -webkit-optimize-contrast;
        }

        .instruction-box {
            background-color: #e9f7ef;
            border: 1px solid #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .payment-display-section {
            display: none; /* Hidden by default, shown by JS */
            padding: 10px;
            border: 1px dashed #ccc;
            margin-bottom: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        .payment-display-section p {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>Welcome to Accessible World Tutorials</h1>
        <div class="profile-container">
            <button id="profileBtn" aria-expanded="false" aria-controls="profileDetails">Profile</button>
            <div id="profileDetails" class="profile-dropdown">
                <p><strong>Name:</strong> <span id="user-name"></span></p>
                <p><strong>Mobile:</strong> <span id="user-mobile"></span></p>
                <p><strong>Email:</strong> <span id="user-email"></span></p>
                <p><strong>Payment Status:</strong> <span id="user-payment-status"></span></p>
                <button id="logout" style="background:#dc3545">Logout</button>
            </div>
        </div>

        <h2>Your Referral Link</h2>
        <p><span id="referral-link"></span></p>
        <button id="copyLink">Copy Link</button>
        <p>To understand how the referral system works, click <a href="how_referral.html" target="_blank">Click Here</a>.</p>
    </div>

    <h2>About Us</h2>
<p>At Accessible World Tutorials, we are committed to making the digital world inclusive and accessible for everyone. Our platform currently offers high-quality learning materials on HTML, web accessibility testing, interview preparation, general knowledge, and current affairs. These topics feature clear explanations, video lessons, and practical examples with in-browser code viewing for HTML tutorials. Content on JavaScript, stock market education, and the latest tech updates for Android and Windows is coming soon. Accessibility is at the core of everything we do â€” with expert guidance, comprehensive resources, and engaging content, we ensure a learning experience that is both empowering and effective. 
By joining us with just a one-time subscription, you'll unlock free access to our full course on accessibility testing, valuable general knowledge and current affairs content, and viewable HTML practical files with video lessons. Join now to learn, grow, and succeed in an inclusive environment designed to support your journey every step of the way.</p>


    <div id="payment-section">
    <div id="payment-rejected" style="display:none; margin-top:10px; background-color: #ffe6e6; border: 1px solid #ffcccc; padding: 15px; border-radius: 5px; color: #cc0000;">
<h3>Payment Not Received</h3>
        <p style="font-weight: bold;">We have not received the payment.</p>
        <p>Please share the payment successful screenshot to the mobile: <strong style="font-size: 1.1em;">7731879173</strong>.</p>
    <p>If the money was not deducted from your account or has already been refunded, click the button below to make the payment again.</p>    
</div>
        <button id="initiatePaymentBtn">Join and Pay â‚¹1000 Membership</button>
    </div>
    <div id="payment-review" style="display:none; margin-top:10px;">
        <p style="color:orange;">Your payment is under review. We will verify it within 6 hours. Would you like to access the courses quickly in 30 minuts, call on this number +917731879173. Thank you for your patience!</p>
    </div>

    <div id="course-access" style="display:none; margin-top:10px;">
<h3>Access Your Paid Courses</h3>
        <p style="color:green;">You are already a registered paid member. To access your exclusive course content, please click the button below.</p>
        <button id="coursesBtn">Access Courses</button>
    </div>

    <div class="card">
        <button id="toggleReferral" aria-expanded="false">Show/Hide Referral Details</button>
        <div id="referralSection" style="display:none;">
            <h3>Referral Overview</h3>
            <p>Total Referrals: <span id="referral-count">0</span></p>
            <h4>Withdrawal Summary</h4>
            <p><strong>Total Withdrawn as of now:</strong> <span id="total-withdrawn-display">â‚¹0</span></p>
            <p><strong>Available Balance:</strong> <span id="available-balance-display">â‚¹0</span></p>
            <p>Total Earnings: <span id="total-earnings">â‚¹0</span></p>
            <h3>Withdrawal History</h3>
            <p>You can view all your past withdrawal transactions using the link below.<br>
            <a href="withdraw_history.html">View Withdrawal History</a></p>
            <table aria-label="Referral History Table">
                <thead>
                    <tr>
                        <th>Level</th>
                        <th>Name</th>
                        <th>Mobile</th>
                        <th>Email</th>
                        <th>Payment Status</th>
                        <th>Earning</th>
                    </tr>
                </thead>
                <tbody id="referral-details"></tbody>
            </table>
            <div class="card">
                <h3>Withdraw Earnings</h3>
                <p id="withdraw-status"></p>
                <div style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">
                    <button id="withdrawBtn">Request Withdrawal</button>
                </div>
            </div>
        </div>
    </div>

    <div id="admin-section" class="admin-section" style="display:none">
        <h3>Admin: Pending Withdrawals</h3>
        <div id="withdrawal-list"></div>
        <hr>
        <h3>Admin: Pending Manual Payments</h3>
        <div id="manual-payment-list"></div>
    </div>

    <div id="withdrawModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="withdrawModalTitle" aria-describedby="withdrawModalDescription" tabindex="-1">
        <div class="modal-content">
            <button class="close-button" aria-label="Close Withdrawal Modal">&times;</button>
            <h3 id="withdrawModalTitle">Withdrawal Request</h3>
            <p id="withdrawModalDescription" class="visually-hidden">Fill out the form below to request a withdrawal of your earnings.</p>
            <div class="modal-input-group">
                <label for="totalAmount">Total Amount:</label>
                <input type="text" id="totalAmount" value="â‚¹0" readonly>
            </div>
            <div class="modal-input-group">
                <label for="paymentMethod">Payment Method:</label>
                <select id="paymentMethod">
                    <option value="">Select Method</option>
                    <option value="phonepay">PhonePe</option>
                    <option value="googlepay">Google Pay</option>
                    <option value="upi">UPI</option>
                </select>
            </div>
            <div id="paymentDetails" style="display:none;">
                <div class="modal-input-group">
                    <label for="paymentId">Enter UPI ID/Number:</label>
                    <input type="text" id="paymentId" placeholder="Enter your ID">
                </div>
                <div class="modal-input-group">
                    <label for="availableAmount">Available Amount:</label>
                    <input type="text" id="availableAmount" value="â‚¹0" readonly>
                </div>
                <div class="modal-input-group">
                    <label for="withdrawAmount">Withdraw Amount:</label>
                    <input type="number" id="withdrawAmount" placeholder="Enter amount to withdraw [Minimum 100]">
                </div>
            </div>
            <div class="modal-actions">
                <button id="submitWithdrawal" disabled>Submit Withdrawal</button>
                <button id="cancelWithdrawal">Cancel</button>
            </div>
        </div>
    </div>

    <div id="paymentFormModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="paymentFormModalTitle" aria-describedby="paymentFormModalDescription" tabindex="-1">
        <div class="modal-content">
            <button class="close-button" aria-label="Close Payment Form Modal">&times;</button>
            <h3 id="paymentFormModalTitle">Complete Your Membership Payment</h3>
            <p id="paymentFormModalDescription" class="visually-hidden">Follow the instructions to make your membership payment and submit the details.</p>

            <div style="background-color: #fff3cd; border: 1px solid #ffeeba; border-radius: 5px; padding: 15px; margin-bottom: 20px; color: #856404;">
                <p style="font-weight: bold; margin-bottom: 10px;">Important Payment Instructions:</p>
                <p>
                    You need to click on the **Submit Payment Details** button after your manual payment, otherwise the admin will not receive your payment request.
                </p>
                <p style="margin-top: 10px;">
                    For faster course activation after a successful payment, please call the admin on:
                    <strong style="color: #007bff; font-size: 1.1em;">7731879173</strong>.
                </p>
            </div>
            <div class="instruction-box">
                To become a paid member, please transfer **â‚¹1000** using one of the methods below. After payment, fill out the form and submit it for verification. Your access will be granted within 6 hours, If it is not granded, call on my number.
            </div>

            <h4>Your Payment Information:</h4>
            <div class="modal-input-group">
                <label for="paymentFullName">Full Name:</label>
                <input type="text" id="paymentFullName" placeholder="Enter your full name" readonly>
            </div>
            <div class="modal-input-group">
                <label for="paymentPhoneNumber">Phone Number:</label>
                <input type="text" id="paymentPhoneNumber" placeholder="Enter your phone number" readonly>
            </div>
            <div class="modal-input-group">
                <label for="paymentEmail">Email:</label>
                <input type="text" id="paymentEmail" placeholder="Enter your email" readonly>
            </div>

            <div class="modal-input-group">
                <label for="chosenPaymentMethod">Payment Method You Will Use:</label>
                <select id="chosenPaymentMethod">
                    <option value="">-- Select Payment Method --</option>
                    <option value="upi_id">UPI ID</option>
                    <option value="phonepe_number">PhonePe Number</option>
                    <option value="googlepay_number">Google Pay Number</option>
                    <option value="qr_code">QR Code</option>
                    <option value="bank_transfer">Bank Account Transfer</option>
                </select>
            </div>

            <div id="paymentDetailsDisplay" class="payment-display-section">
            </div>
            <div class="modal-input-group">
                <label for="transactionId">Transaction ID / Reference Number (Optional but Recommended):</label>
                <input type="text" id="transactionId" placeholder="e.g., UPI Ref ID, Bank Txn ID">
            </div>
            <div class="modal-input-group">
                <label for="screenshotUpload">Upload Screenshot (Optional):</label>
                <input type="file" id="screenshotUpload" accept="image/*">

                <input type="checkbox" id="paymentConfirmationCheckbox">
                <label for="paymentConfirmationCheckbox">Select this checkbox if you have already made the payment.</label>
                <p>Without making the payment, you cannot submit this form.</p>

            </div>
            <div class="modal-actions">
                <button id="submitManualPayment">Submit Payment Details</button>
                <button id="cancelManualPayment">Cancel</button>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 Accessible World Tutorials</p>
        <a href="privacy.html" target="_blank">Privacy Policy</a>
        <a href="terms.html" target="_blank">Terms of Service</a>
        <a href="/contact.html" target="_blank">Contact Us</a>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import {
            getFirestore, doc, getDoc, collection,
            query, where, getDocs, updateDoc,
            addDoc, serverTimestamp, setDoc
        } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";


        const firebaseConfig = {
            apiKey: "AIzaSyBWtr_ZwK8hfA1We-yq9uUOjw5C6wXhx0k",
            authDomain: "accessibleworld-7f599.firebaseapp.com",
            projectId: "accessibleworld-7f599",
            storageBucket: "accessibleworld-7f599.appspot.com",
            messagingSenderId: "264437218598",
            appId: "1:264437218598:web:cae58c1e578c7b08b815e7",
            measurementId: "G-1QRWXYRZ76"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore(app);
        const storage = getStorage(app);

        // New profile elements
        const profileBtn = document.getElementById("profileBtn");
        const profileDetails = document.getElementById("profileDetails");

        const nameField = document.getElementById("user-name");
        const mobileField = document.getElementById("user-mobile");
        const emailField = document.getElementById("user-email");
        const paymentField = document.getElementById("user-payment-status");
        const initiatePaymentBtn = document.getElementById("initiatePaymentBtn");
        const logoutBtn = document.getElementById("logout");
        const referralLinkField = document.getElementById("referral-link");
        const copyLinkBtn = document.getElementById("copyLink");
        const toggleReferralBtn = document.getElementById("toggleReferral");
        const referralSection = document.getElementById("referralSection");
        const referralCountField = document.getElementById("referral-count");
        const earningsField = document.getElementById("total-earnings");
        const referralDetails = document.getElementById("referral-details");
        const withdrawBtn = document.getElementById("withdrawBtn");
        const statusMessage = document.getElementById("withdraw-status");
        const adminSection = document.getElementById("admin-section");
        const withdrawalList = document.getElementById("withdrawal-list");
        const paymentSection = document.getElementById("payment-section");
        const paymentReviewSection = document.getElementById("payment-review");
        const paymentRejectedSection = document.getElementById("payment-rejected");
        const courseAccessSection = document.getElementById("course-access");
        const coursesBtn = document.getElementById("coursesBtn");
        const manualPaymentList = document.getElementById("manual-payment-list");

        // New elements for withdrawal summary
        const totalWithdrawnDisplay = document.getElementById("total-withdrawn-display");
        const availableBalanceDisplay = document.getElementById("available-balance-display");

        // Withdrawal Modal elements
        const withdrawModal = document.getElementById("withdrawModal");
        const withdrawModalCloseButton = withdrawModal.querySelector(".close-button");
        const withdrawModalTitle = document.getElementById("withdrawModalTitle");
        const totalAmountModal = document.getElementById("totalAmount");
        const paymentMethodDropdown = document.getElementById("paymentMethod");
        const paymentDetailsDiv = document.getElementById("paymentDetails");
        const paymentIdInput = document.getElementById("paymentId");
        const availableAmountInput = document.getElementById("availableAmount");
        const withdrawAmountInput = document.getElementById("withdrawAmount");
        const submitWithdrawalButton = document.getElementById("submitWithdrawal");
        const cancelWithdrawalButton = document.getElementById("cancelWithdrawal");

        // New Payment Form Modal elements
        const paymentFormModal = document.getElementById("paymentFormModal");
        const paymentFormModalCloseButton = paymentFormModal.querySelector(".close-button");
        const paymentFormModalTitle = document.getElementById("paymentFormModalTitle");
        const paymentFullNameInput = document.getElementById("paymentFullName");
        const paymentPhoneNumberInput = document.getElementById("paymentPhoneNumber");
        const paymentEmailInput = document.getElementById("paymentEmail");
        const chosenPaymentMethodSelect = document.getElementById("chosenPaymentMethod");
        const paymentDetailsDisplay = document.getElementById("paymentDetailsDisplay");
        const transactionIdInput = document.getElementById("transactionId");
        const screenshotUploadInput = document.getElementById("screenshotUpload");
        const submitManualPaymentBtn = document.getElementById("submitManualPayment");
        const cancelManualPaymentBtn = document.getElementById("cancelManualPayment");
        // Corrected ID for the checkbox:
        const paymentConfirmationCheckbox = document.getElementById('paymentConfirmationCheckbox');


        let currentUserId, currentUserName, currentUserMobile, currentUserEmail, currentEarnings = 0;
        let lastFocusedElement = null; // To store the element that opened the modal
            // --- Our Payment Details (Centralized for easy editing) ---
            const OUR_PAYMENT_DETAILS = {
                upi_id: {
                    label: "Our UPI ID",
                    value: "7702675618@ybl", // <<< REPLACE THIS
                    instructions: "Use any UPI app (Google Pay, PhonePe, Paytm, etc.) to send â‚¹1000 to this UPI ID."
                },
                phonepe_number: {
                    label: "Our PhonePe Number",
                    value: "7702675618", // <<< REPLACE THIS
                    instructions: "Open PhonePe, go to 'To Mobile Number' and send â‚¹1000 to this number. The name will display as Ravva Gowri."
                },
                googlepay_number: {
                    label: "Our Google Pay Number",
                    value: "7702675618", // <<< REPLACE THIS (Can be same as PhonePe or different)
                    instructions: "Open Google Pay, go to 'Pay phone number' and send â‚¹1000 to this number."
                },
                qr_code: {
                    label: "Scan Our QR Code",
                    imageUrl: "qr_scanner.png", // <<< REPLACE THIS with your actual QR code image path
                    instructions: "Scan the QR code to pay â‚¹1000. Place your screen reader focus on the QR code image. Then, use PhonePe, Google Pay, or any other UPI app on your phone to scan the QR code and complete the payment."
                },
                bank_transfer: {
                    label: "Our Bank Account Details",
                    accountName: "Pentakota Raviteja",    // <<< REPLACE THIS
                    accountNumber: "35838062455", // <<< REPLACE THIS
                    ifscCode: "SBIN0021121",              // <<< REPLACE THIS
                    instructions: "Transfer â‚¹1000 directly to our bank account using NEFT/IMPS/RTGS. Please use your registered email/phone in the transaction remarks if possible."
                }
            };

            // --- Utility Functions ---

            // Function to open any modal
            function openModal(modalElement) {
                lastFocusedElement = document.activeElement; // Store the currently focused element
                modalElement.style.display = 'block';
                modalElement.setAttribute('aria-hidden', 'false');
                document.body.classList.add('modal-open');
                modalElement.focus(); // Focus the modal itself for screen readers
                trapFocus(modalElement); // Start trapping focus
            }

            // Function to close any modal
            function closeModal(modalElement) {
                modalElement.style.display = 'none';
                modalElement.setAttribute('aria-hidden', 'true');
                document.body.classList.remove('modal-open');
                if (lastFocusedElement) {
                    lastFocusedElement.focus(); // Return focus to the element that opened the modal
                    lastFocusedElement = null; // Clear the stored element
                }
            }

            // Function to trap focus inside a modal
            function trapFocus(modalElement) {
                const focusableElements = modalElement.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                const firstFocusableElement = focusableElements[0];
                const lastFocusableElement = focusableElements[focusableElements.length - 1];

                modalElement.addEventListener('keydown', function(e) {
                    const isTabPressed = (e.key === 'Tab');

                    if (!isTabPressed) {
                        return;
                    }

                    if (e.shiftKey) { // if shift key and tab key are pressed
                        if (document.activeElement === firstFocusableElement) {
                            lastFocusableElement.focus(); // add focus to the last focusable element
                            e.preventDefault();
                        }
                    } else { // if tab key is pressed
                        if (document.activeElement === lastFocusableElement) {
                            firstFocusableElement.focus(); // add focus to the first focusable element
                            e.preventDefault();
                        }
                    }
                });
            }


            async function fetchReferralLevels(uid, level=1, max=5) {
                if(level > max) return [];
                const q = query(collection(db,"users"), where("referredBy","==",uid));
                const snap = await getDocs(q);
                let out=[];
                for(const ds of snap.docs) {
                    const d=ds.data();
                    // Only consider paid referrals for earnings calculation
                    const earning = calculateReferralEarning(level, d.paymentStatus);
                    out.push({ level, fullName:d.fullName, mobile:d.phoneNumber, email:d.email, paymentStatus:d.paymentStatus, uid:ds.id, earning }); // Used phoneNumber
                    out = out.concat(await fetchReferralLevels(ds.id, level + 1, max));
                }
                return out;
            }

            function calculateReferralEarning(level, paymentStatus) {
                if (paymentStatus !== "Paid") return 0;
                if (level === 1) return 240;
                if (level === 2) return 150;
                if (level === 3) return 110;
                if (level === 4) return 60;
                if (level === 5) return 40;
                return 0;
            }

            async function fetchWithdrawalsForAdmin() {
                withdrawalList.innerHTML = "";
                const q = query(collection(db, "withdrawals"), where("status", "==", "Pending"));
                const snap = await getDocs(q);
                if (snap.empty) {
                    withdrawalList.innerHTML = "<p>No pending withdrawals.</p>";
                    return;
                }
                snap.forEach(docSnap => {
                    const data = docSnap.data();
                    const card = document.createElement("div");
                    card.className = "withdrawal-card";
                    card.innerHTML = `
                        <p><strong>Name:</strong> ${data.fullName}</p>
                        <p><strong>Email:</strong> ${data.email}</p>
                        <p><strong>Phone:</strong> ${data.phone}</p>
                        <p><strong>Amount:</strong> â‚¹${data.amount}</p>
                        <p><strong>Method:</strong> ${data.paymentMethod}</p>
                        <p><strong>ID/Number:</strong> ${data.paymentId}</p>
                        <p><strong>Date:</strong> ${data.requestedAt?.toDate().toLocaleString() || "N/A"}</p>
                        <p><strong>Status:</strong> ${data.status}</p>
                        <button data-id="${docSnap.id}" class="approve-withdrawal-btn" style="background:#28a745; margin-right: 10px;">Approve</button>
                        <button data-id="${docSnap.id}" class="reject-withdrawal-btn" style="background:#dc3545;">Reject</button>
                    `;
                    withdrawalList.appendChild(card);
                });

                document.querySelectorAll(".approve-withdrawal-btn").forEach(button => {
                    button.addEventListener("click", async (e) => {
                        const withdrawalId = e.target.dataset.id;
                        await updateWithdrawalStatus(withdrawalId, "Approved");
                    });
                });

                document.querySelectorAll(".reject-withdrawal-btn").forEach(button => {
                    button.addEventListener("click", async (e) => {
                        const withdrawalId = e.target.dataset.id;
                        await updateWithdrawalStatus(withdrawalId, "Rejected");
                    });
                });
            }

            async function updateWithdrawalStatus(withdrawalId, status) {
                try {
                    await updateDoc(doc(db, "withdrawals", withdrawalId), {
                        status: status,
                        processedAt: serverTimestamp()
                    });
                    alert(`Withdrawal ${status} successfully!`);
                    fetchWithdrawalsForAdmin(); // Refresh the list
                } catch (error) {
                    console.error(`Error updating withdrawal status to ${status}:`, error);
                    alert(`Failed to ${status} withdrawal.`);
                }
            }

            async function fetchManualPaymentsForAdmin() {
                manualPaymentList.innerHTML = "";
                const q = query(collection(db, "manualPayments"), where("status", "==", "Pending"));
                const snap = await getDocs(q);
                if (snap.empty) {
                    manualPaymentList.innerHTML = "<p>No pending manual payments.</p>";
                    return;
                }
                snap.forEach(docSnap => {
                    const data = docSnap.data();
                    const card = document.createElement("div");
                    card.className = "withdrawal-card"; // Reusing style
                    card.innerHTML = `
                        <p><strong>User ID:</strong> ${data.userId}</p>
                        <p><strong>Name:</strong> ${data.fullName}</p>
                        <p><strong>Email:</strong> ${data.email}</p>
                        <p><strong>Phone:</strong> ${data.phoneNumber}</p>
                        <p><strong>Method:</strong> ${data.chosenPaymentMethod}</p>
                        <p><strong>Transaction ID:</strong> ${data.transactionId || "N/A"}</p>
                        ${data.screenshotURL ? `<p><strong>Screenshot:</strong> <a href="${data.screenshotURL}" target="_blank">View Screenshot</a></p>` : ""}
                        <p><strong>Submitted At:</strong> ${data.submittedAt?.toDate().toLocaleString() || "N/A"}</p>
                        <p><strong>Status:</strong> ${data.status}</p>
                        <button data-id="${docSnap.id}" data-user-id="${data.userId}" class="approve-payment-btn" style="background:#28a745; margin-right: 10px;">Approve Payment</button>
                        <button data-id="${docSnap.id}" data-user-id="${data.userId}" class="reject-payment-btn" style="background:#dc3545;">Reject Payment</button>
                    `;
                    manualPaymentList.appendChild(card);
                });

                document.querySelectorAll(".approve-payment-btn").forEach(button => {
                    button.addEventListener("click", async (e) => {
                        const paymentId = e.target.dataset.id;
                        const userId = e.target.dataset.userId;
                        await updateManualPaymentStatus(paymentId, userId, "Approved");
                    });
                });

                document.querySelectorAll(".reject-payment-btn").forEach(button => {
                    button.addEventListener("click", async (e) => {
                        const paymentId = e.target.dataset.id;
                        const userId = e.target.dataset.userId;
                        await updateManualPaymentStatus(paymentId, userId, "Rejected");
                    });
                });
            }

            async function updateManualPaymentStatus(paymentId, userId, status) {
                try {
                    await updateDoc(doc(db, "manualPayments", paymentId), {
                        status: status,
                        processedAt: serverTimestamp()
                    });

                    // Update the user's payment status based on admin action
                    if (status === "Approved") {
                        await updateDoc(doc(db, "users", userId), {
                            paymentStatus: "Paid"
                        });
                        alert("Payment approved and user payment status updated to 'Paid'.");
                    } else if (status === "Rejected") {
                        await updateDoc(doc(db, "users", userId), {
                            paymentStatus: "Rejected"
                        });
                        alert("Payment rejected and user payment status updated to 'Rejected'.");
                    }
                    fetchManualPaymentsForAdmin(); // Refresh the list
                    // Re-fetch user data to update the dashboard display
                    if (userId === currentUserId) {
                        await fetchUserData(currentUserId);
                    }
                } catch (error) {
                    console.error(`Error updating manual payment status to ${status}:`, error);
                    alert(`Failed to ${status} manual payment.`);
                }
            }


            async function fetchUserData(uid) {
                if (!uid) {
                    console.log("No user ID available to fetch data.");
                    nameField.textContent = "N/A";
                    mobileField.textContent = "N/A";
                    emailField.textContent = "N/A";
                    paymentField.textContent = "N/A";
                    referralLinkField.textContent = "Please log in to see your referral link.";
                    paymentSection.style.display = "block";
                    paymentReviewSection.style.display = "none";
                    paymentRejectedSection.style.display = "none";
                    courseAccessSection.style.display = "none";
                    return;
                }

                try {
                    const userDocRef = doc(db, "users", uid);
                    const userDocSnap = await getDoc(userDocRef);

                    if (userDocSnap.exists()) {
                        const userData = userDocSnap.data();
                        currentUserName = userData.fullName || "N/A";
                        currentUserMobile = userData.phoneNumber || "N/A";
                        currentUserEmail = userData.email || "N/A";
                        const paymentStatus = userData.paymentStatus || "Unpaid";
                        const isAdmin = userData.isAdmin || false; // Check for admin status

                        nameField.textContent = currentUserName;
                        mobileField.textContent = currentUserMobile;
                        emailField.textContent = currentUserEmail;
                        paymentField.textContent = paymentStatus;

                        // Set values for payment form modal
                        paymentFullNameInput.value = currentUserName;
                        paymentPhoneNumberInput.value = currentUserMobile;
                        paymentEmailInput.value = currentUserEmail;

                        const referralLink = `${window.location.origin}/signup.html?ref=${uid}`;
                        referralLinkField.textContent = referralLink;

                        // Handle UI based on payment status
                        if (paymentStatus === "Paid") {
                            paymentSection.style.display = "none";
                            paymentReviewSection.style.display = "none";
                            paymentRejectedSection.style.display = "none";
                            courseAccessSection.style.display = "block";
                        } else if (paymentStatus === "Under Review") {
                            paymentSection.style.display = "none";
                            paymentReviewSection.style.display = "block";
                            paymentRejectedSection.style.display = "none";
                            courseAccessSection.style.display = "none";
                        } else if (paymentStatus === "Rejected") {
                            paymentSection.style.display = "none"; // Hide standard payment button
                            paymentReviewSection.style.display = "none";
                            paymentRejectedSection.style.display = "block"; // Show rejected message
                            courseAccessSection.style.display = "none";
                        } else { // Unpaid or any other status
                            paymentSection.style.display = "block";
                            paymentReviewSection.style.display = "none";
                            paymentRejectedSection.style.display = "none";
                            courseAccessSection.style.display = "none";
                        }

                        // Admin section visibility
                        if (isAdmin) {
                            adminSection.style.display = "block";
                            fetchWithdrawalsForAdmin();
                            fetchManualPaymentsForAdmin();
                        } else {
                            adminSection.style.display = "none";
                        }

                        // Fetch referral data
                        const referrals = await fetchReferralLevels(uid);
                        referralCountField.textContent = referrals.filter(r => r.paymentStatus === "Paid").length;
                        currentEarnings = referrals.reduce((sum, r) => sum + r.earning, 0);
                        earningsField.textContent = `â‚¹${currentEarnings}`;

                        // Fetch previous withdrawals for the user
                        const withdrawalQuery = query(collection(db, "withdrawals"), where("userId", "==", uid), where("status", "==", "Approved"));
                        const withdrawalSnap = await getDocs(withdrawalQuery);
                        let totalWithdrawn = 0;
                        withdrawalSnap.forEach(doc => {
                            totalWithdrawn += doc.data().amount;
                        });

                        totalWithdrawnDisplay.textContent = `â‚¹${totalWithdrawn}`;
                        availableBalanceDisplay.textContent = `â‚¹${currentEarnings - totalWithdrawn}`;
                        totalAmountModal.value = `â‚¹${currentEarnings - totalWithdrawn}`;
                        availableAmountInput.value = `â‚¹${currentEarnings - totalWithdrawn}`;

                        referralDetails.innerHTML = "";
                        if (referrals.length === 0) {
                            referralDetails.innerHTML = '<tr><td colspan="6">No referrals found yet. Share your link to earn!</td></tr>';
                        } else {
                            referrals.forEach(r => {
                                const row = document.createElement("tr");
                                row.innerHTML = `
                                    <td>${r.level}</td>
                                    <td>${r.fullName}</td>
                                    <td>${r.mobile}</td>
                                    <td>${r.email}</td>
                                    <td>${r.paymentStatus}</td>
                                    <td>â‚¹${r.earning}</td>
                                `;
                                referralDetails.appendChild(row);
                            });
                        }

                    } else {
                        console.log("No user data found for this UID.");
                        // Handle case where user document doesn't exist (e.g., new user or data issue)
                        nameField.textContent = "N/A";
                        mobileField.textContent = "N/A";
                        emailField.textContent = "N/A";
                        paymentField.textContent = "N/A";
                        referralLinkField.textContent = "User data not found.";
                        paymentSection.style.display = "block"; // Show payment option by default
                        paymentReviewSection.style.display = "none";
                        paymentRejectedSection.style.display = "none";
                        courseAccessSection.style.display = "none";
                    }
                } catch (error) {
                    console.error("Error fetching user data:", error);
                    alert("Error loading user data. Please try refreshing the page.");
                    nameField.textContent = "Error";
                    mobileField.textContent = "Error";
                    emailField.textContent = "Error";
                    paymentField.textContent = "Error";
                    referralLinkField.textContent = "Error loading link.";
                    paymentSection.style.display = "block"; // Allow user to try initiating payment again
                    paymentReviewSection.style.display = "none";
                    paymentRejectedSection.style.display = "none";
                    courseAccessSection.style.display = "none";
                }
            }

            // --- Event Listeners ---

            profileBtn.addEventListener("click", () => {
                const isExpanded = profileBtn.getAttribute("aria-expanded") === "true";
                profileBtn.setAttribute("aria-expanded", !isExpanded);
                profileDetails.style.display = isExpanded ? "none" : "block";
            });

            logoutBtn.addEventListener("click", async () => {
                try {
                    await signOut(auth);
                    window.location.href = "index.html"; // Redirect to login page
                } catch (error) {
                    console.error("Error signing out:", error);
                    alert("Failed to log out. Please try again.");
                }
            });

            copyLinkBtn.addEventListener("click", async () => {
                const referralLink = referralLinkField.textContent;
                try {
                    await navigator.clipboard.writeText(referralLink);
                    alert("Referral link copied to clipboard!");
                } catch (err) {
                    console.error("Failed to copy: ", err);
                    alert("Failed to copy link. Please copy it manually: " + referralLink);
                }
            });

            toggleReferralBtn.addEventListener("click", () => {
                const isExpanded = toggleReferralBtn.getAttribute("aria-expanded") === "true";
                toggleReferralBtn.setAttribute("aria-expanded", !isExpanded);
                referralSection.style.display = isExpanded ? "none" : "block";
            });

            coursesBtn.addEventListener("click", () => {
                alert("Redirecting to courses page!");
                // window.location.href = "courses.html"; // Uncomment and replace with your actual courses page
            });


            // Withdrawal Modal Logic
            withdrawBtn.addEventListener("click", () => {
                const availableBalance = parseFloat(availableBalanceDisplay.textContent.replace('â‚¹', ''));
                if (availableBalance < 100) {
                    alert("Minimum withdrawal amount is â‚¹100.");
                    return;
                }
                totalAmountModal.value = `â‚¹${availableBalance}`;
                availableAmountInput.value = `â‚¹${availableBalance}`;
                withdrawAmountInput.value = ""; // Clear previous input
                paymentMethodDropdown.value = ""; // Reset dropdown
                paymentDetailsDiv.style.display = "none"; // Hide details until method is selected
                submitWithdrawalButton.disabled = true; // Disable until valid input
                openModal(withdrawModal);
            });

            withdrawModalCloseButton.addEventListener("click", () => {
                closeModal(withdrawModal);
            });
            cancelWithdrawalButton.addEventListener("click", () => {
                closeModal(withdrawModal);
            });

            paymentMethodDropdown.addEventListener("change", () => {
                const selectedMethod = paymentMethodDropdown.value;
                paymentDetailsDiv.style.display = selectedMethod ? "block" : "none";
                paymentIdInput.value = ""; // Clear previous ID

                if (selectedMethod) {
                    paymentIdInput.placeholder = `Enter your ${selectedMethod} ID/Number`;
                    submitWithdrawalButton.disabled = false; // Enable once method selected
                } else {
                    submitWithdrawalButton.disabled = true;
                }
            });

            withdrawAmountInput.addEventListener("input", () => {
                const availableBalance = parseFloat(availableAmountInput.value.replace('â‚¹', ''));
                const withdrawAmount = parseFloat(withdrawAmountInput.value);

                if (isNaN(withdrawAmount) || withdrawAmount < 100 || withdrawAmount > availableBalance) {
                    submitWithdrawalButton.disabled = true;
                    statusMessage.textContent = "Withdrawal amount must be at least â‚¹100 and not exceed available balance.";
                    statusMessage.style.color = "red";
                } else {
                    submitWithdrawalButton.disabled = false;
                    statusMessage.textContent = "";
                }
            });

            submitWithdrawalButton.addEventListener("click", async () => {
                const amount = parseFloat(withdrawAmountInput.value);
                const method = paymentMethodDropdown.value;
                const paymentId = paymentIdInput.value.trim();
                const availableBalance = parseFloat(availableAmountInput.value.replace('â‚¹', ''));

                if (isNaN(amount) || amount < 100 || amount > availableBalance) {
                    alert("Please enter a valid withdrawal amount (minimum â‚¹100 and not exceeding available balance).");
                    return;
                }
                if (!method) {
                    alert("Please select a payment method.");
                    return;
                }
                if (!paymentId) {
                    alert("Please enter your UPI ID/Number.");
                    return;
                }
                if (!currentUserId) {
                    alert("User not logged in. Please refresh and try again.");
                    return;
                }

                try {
                    await addDoc(collection(db, "withdrawals"), {
                        userId: currentUserId,
                        fullName: currentUserName,
                        email: currentUserEmail,
                        phone: currentUserMobile, // Add phone number to withdrawal record
                        amount: amount,
                        paymentMethod: method,
                        paymentId: paymentId,
                        status: "Pending",
                        requestedAt: serverTimestamp()
                    });

                    // Deduct the withdrawn amount from the user's earnings balance
                    const userDocRef = doc(db, "users", currentUserId);
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        const userData = userDocSnap.data();
                        const currentTotalEarnings = userData.totalEarnings || 0;
                        const currentTotalWithdrawn = userData.totalWithdrawn || 0;

                        await updateDoc(userDocRef, {
                            totalEarnings: currentTotalEarnings - amount, // Deduct from totalEarnings for simplicity or adjust as per your earnings model
                            totalWithdrawn: currentTotalWithdrawn + amount
                        });
                    }

                    alert("Withdrawal request submitted successfully! It will be processed soon.");
                    closeModal(withdrawModal);
                    await fetchUserData(currentUserId); // Refresh dashboard to show updated balance
                } catch (error) {
                    console.error("Error submitting withdrawal:", error);
                    alert("Failed to submit withdrawal request.");
                }
            });

            // Initiate Payment Modal Logic
            initiatePaymentBtn.addEventListener("click", () => {
                openModal(paymentFormModal);
                // Pre-fill user details if available
                paymentFullNameInput.value = currentUserName || '';
                paymentPhoneNumberInput.value = currentUserMobile || '';
                paymentEmailInput.value = currentUserEmail || '';
                // Reset fields
                chosenPaymentMethodSelect.value = '';
                paymentDetailsDisplay.style.display = 'none';
                paymentDetailsDisplay.innerHTML = '';
                transactionIdInput.value = '';
                screenshotUploadInput.value = '';
                paymentConfirmationCheckbox.checked = false; // Ensure checkbox is unchecked initially
            });

            paymentFormModalCloseButton.addEventListener("click", () => {
                closeModal(paymentFormModal);
            });

            cancelManualPaymentBtn.addEventListener("click", () => {
                closeModal(paymentFormModal);
            });

            chosenPaymentMethodSelect.addEventListener("change", () => {
                const selectedMethod = chosenPaymentMethodSelect.value;
                const detailsContainer = paymentDetailsDisplay;
                detailsContainer.innerHTML = ''; // Clear previous details

                if (selectedMethod && OUR_PAYMENT_DETAILS[selectedMethod]) {
                    const methodInfo = OUR_PAYMENT_DETAILS[selectedMethod];
                    detailsContainer.style.display = 'block';

                    let content = `<h4>${methodInfo.label}</h4><p>${methodInfo.instructions}</p>`;

                    if (methodInfo.value) {
                        content += `<p><strong>${methodInfo.label}:</strong> <span style="font-size: 1.1em; color: #0056b3;">${methodInfo.value}</span></p>`;
                    }
                    if (methodInfo.accountName) {
                        content += `<p><strong>Account Name:</strong> <span style="font-size: 1.1em; color: #0056b3;">${methodInfo.accountName}</span></p>`;
                        content += `<p><strong>Account Number:</strong> <span style="font-size: 1.1em; color: #0056b3;">${methodInfo.accountNumber}</span></p>`;
                        content += `<p><strong>IFSC Code:</strong> <span style="font-size: 1.1em; color: #0056b3;">${methodInfo.ifscCode}</span></p>`;
                    }
                    if (methodInfo.imageUrl) {
                        content += `<img src="${methodInfo.imageUrl}" alt="${methodInfo.label} QR Code" aria-label="${methodInfo.label} QR Code">`;
                    }
                    detailsContainer.innerHTML = content;
                } else {
                    detailsContainer.style.display = 'none';
                }
            });

            // Submit Manual Payment
            submitManualPaymentBtn.addEventListener("click", async () => {
                // **THIS IS THE CRUCIAL CHANGE: Check checkbox status on submit click**
                if (!paymentConfirmationCheckbox.checked) {
                    alert("Please confirm that you have made the payment by selecting the checkbox.");
                    return; // Stop the submission process
                }

                const chosenMethod = chosenPaymentMethodSelect.value;
                const transactionId = transactionIdInput.value.trim();
                const screenshotFile = screenshotUploadInput.files[0];

                if (!chosenMethod) {
                    alert("Please select a payment method.");
                    return;
                }

                if (!currentUserId) {
                    alert("User not logged in or ID not found. Please refresh and try again.");
                    console.error("currentUserId is null or undefined.");
                    return;
                }

                let screenshotURL = '';
                if (screenshotFile) {
                    const storageRef = ref(storage, `payment_screenshots/${currentUserId}_${Date.now()}_${screenshotFile.name}`);
                    try {
                        const uploadResult = await uploadBytes(storageRef, screenshotFile);
                        screenshotURL = await getDownloadURL(storageRef);
                    } catch (uploadError) {
                        console.error("Error uploading screenshot:", uploadError);
                        alert("Failed to upload screenshot. Please try again. " + (uploadError.message || "Unknown error during upload."));
                        return; // Halting submission if screenshot upload fails.
                    }
                }

                try {
                    // Add payment request to a 'manualPayments' collection for admin review
                    await addDoc(collection(db, "manualPayments"), {
                        userId: currentUserId,
                        fullName: currentUserName,
                        phoneNumber: currentUserMobile,
                        email: currentUserEmail,
                        chosenPaymentMethod: chosenMethod,
                        transactionId: transactionId,
                        screenshotURL: screenshotURL,
                        status: "Pending", // Admin needs to approve
                        submittedAt: serverTimestamp()
                    });

                    // Update user's payment status to "Under Review"
                    await updateDoc(doc(db, "users", currentUserId), {
                        paymentStatus: "Under Review"
                    });


                    alert("Payment details submitted successfully! Your payment is now under review.");
                    closeModal(paymentFormModal);
                    await fetchUserData(currentUserId); // Refresh dashboard to show "Under Review" status
                } catch (error) {
                    console.error("Error submitting manual payment to Firestore:", error);
                    alert("Failed to submit payment details. " + (error.message || "An unknown error occurred. Please check console for details."));
                }
            });


            // Initial authentication state check
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    await fetchUserData(currentUserId);

                    // Check if the user is redirected from a referral link
                    const urlParams = new URLSearchParams(window.location.search);
                    const referrerId = urlParams.get('ref');
                    if (referrerId && referrerId !== currentUserId) {
                        const userDocRef = doc(db, "users", currentUserId);
                        const userDocSnap = await getDoc(userDocRef);

                        if (userDocSnap.exists() && !userDocSnap.data().referredBy) {
                            // Only update if not already referred
                            await updateDoc(userDocRef, {
                                referredBy: referrerId
                            });
                            console.log(`User ${currentUserId} referred by ${referrerId}`);
                            // Optional: Alert or notify the user
                            // alert(`You were referred by user: ${referrerId}`);
                        }
                    }
                } else {
                    currentUserId = null;
                    console.log("No user logged in, redirecting to index.html");
                    window.location.href = "index.html"; // Redirect to login page
                }
            });
    </script>
</body>
</html>