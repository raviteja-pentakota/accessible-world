<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Dashboard | Accessible World Tutorials</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f2f5;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .card {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        button {
            padding: 10px 20px;
            border: none;
            background: #007bff;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        ul {
            padding-left: 20px;
        }
        #referralSection {
            display: none;
        }
        #withdraw-status {
            margin-top: 10px;
            color: green;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th,
        td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f9f9f9;
        }
        .admin-section {
            background: #fffbe6;
            padding: 20px;
            margin-top: 30px;
            border: 1px solid #ffe58f;
            border-radius: 8px;
        }
        .withdrawal-card { /* Reusing this style for manual payment requests for consistency */
            border-bottom: 1px solid #ddd;
            padding: 10px 0;
            margin-bottom: 10px;
        }
        .withdrawal-card:last-child {
            border-bottom: none;
        }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 2; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0, 0, 0, 0.4); /* Black w/ opacity */
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto; /* Adjusted margin for slightly higher position */
            padding: 20px;
            border: 1px solid #888;
            width: 90%; /* Increased width for better mobile view */
            max-width: 600px; /* Max width for larger screens */
            border-radius: 8px;
            position: relative;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
        }

        .modal-input-group {
            margin-bottom: 15px;
        }

        .modal-input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .modal-input-group select,
        .modal-input-group input[type="text"],
        .modal-input-group input[type="number"],
        .modal-input-group input[type="file"] {
            width: calc(100% - 12px);
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .modal-input-group textarea {
            width: calc(100% - 12px);
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            resize: vertical;
        }

        .modal-actions {
            text-align: right;
        }

        .modal-actions button {
            margin-left: 10px;
        }

        /* Footer Styles */
        footer {
            background: #333;
            color: #fff;
            padding: 10px 20px;
            text-align: center;
            margin-top: auto; /* Push footer to the bottom */
            border-radius: 0 0 8px 8px;
        }

        footer a {
            color: #fff;
            text-decoration: none;
            margin: 0 10px;
        }

        footer a:hover {
            text-decoration: underline;
        }

        /* Accessibility helper class to visually hide but keep accessible */
        .visually-hidden {
            position: absolute !important;
            height: 1px;
            width: 1px;
            overflow: hidden;
            clip: rect(1px, 1px, 1px, 1px);
            white-space: nowrap;
        }

        /* Styles for blurring main content when modal is open */
        body.modal-open > *:not(.modal) {
            filter: blur(3px); /* Slightly less blur for better performance */
            pointer-events: none;
            user-select: none;
        }

        /* Styles for profile dropdown */
        .profile-container {
            position: relative;
            display: inline-block;
            float: right; /* To align it to the right */
        }

        .profile-dropdown {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 1;
            right: 0; /* Align dropdown to the right of the button */
            border-radius: 4px;
            padding: 10px;
            top: 40px; /* Position below the button */
        }

        .profile-dropdown p {
            margin: 5px 0;
            padding: 0;
            font-size: 14px;
        }

        .profile-dropdown button {
            width: 100%;
            margin-top: 10px;
        }

        /* Payment details section in modal (original, less specific) */
        #paymentMethodDetails {
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        #paymentMethodDetails div {
            margin-bottom: 10px;
        }

        /* Corrected CSS for image within paymentDetailsDisplay (for QR code) */
        #paymentDetailsDisplay img {
            max-width: 200px; /* Set a maximum width for the image */
            width: 100%; /* Make it responsive within its container */
            height: auto; /* Maintain aspect ratio */
            display: block; /* Make it a block-level element */
            margin: 20px auto; /* Center horizontally with more vertical spacing */
            border: 1px solid #ddd; /* Slightly softer border */
            padding: 8px; /* Slightly more padding */
            box-sizing: border-box;
            border-radius: 4px; /* Slightly rounded corners */

            /* Image rendering for sharp display */
            image-rendering: auto;
            image-rendering: crisp-edges;
            image-rendering: -webkit-optimize-contrast;
        }

        .instruction-box {
            background-color: #e9f7ef;
            border: 1px solid #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .payment-display-section {
            display: none; /* Hidden by default, shown by JS */
            padding: 10px;
            border: 1px dashed #ccc;
            margin-bottom: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        .payment-display-section p {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>Welcome to Accessible World Tutorials</h1>
        <div class="profile-container">
            <button id="profileBtn" aria-expanded="false" aria-controls="profileDetails">Profile</button>
            <div id="profileDetails" class="profile-dropdown">
                <p><strong>Name:</strong> <span id="user-name"></span></p>
                <p><strong>Mobile:</strong> <span id="user-mobile"></span></p>
                <p><strong>Email:</strong> <span id="user-email"></span></p>
                <p><strong>Payment Status:</strong> <span id="user-payment-status"></span></p>
                <button id="logout" style="background:#dc3545">Logout</button>
            </div>
        </div>

        <h2>Your Referral Link</h2>
        <p><span id="referral-link"></span></p>
        <button id="copyLink">Copy Link</button>
        <p>To understand how the referral system works, click <a href="how_referral.html" target="_blank">Click Here</a>.</p>
    </div>

    <h2>About Us</h2>
    <p>At Accessible World Tutorials, we are committed to making the digital world inclusive and accessible for everyone. Our platform currently offers high-quality learning materials on HTML, web accessibility testing, interview preparation, general knowledge, and current affairs. These topics feature clear explanations, video lessons, and practical examples with in-browser code viewing for HTML tutorials. Content on JavaScript, stock market education, and the latest tech updates for Android and Windows is coming soon. Accessibility is at the core of everything we do â€” with expert guidance, comprehensive resources, and engaging content, we ensure a learning experience that is both empowering and effective.
    By joining us with just a one-time subscription, you'll unlock free access to our full course on accessibility testing, valuable general knowledge and current affairs content, and viewable HTML practical files with video lessons. Join now to learn, grow, and succeed in an inclusive environment designed to support your journey every step of the way.</p>


    <div id="payment-section">
        <div id="payment-rejected" style="display:none; margin-top:10px; background-color: #ffe6e6; border: 1px solid #ffcccc; padding: 15px; border-radius: 5px; color: #cc0000;">
            <h3>Payment Rejected:</h3>
            <p style="font-weight: bold;">We have not received the payment.</p>
            <p>Please share the payment successful screenshot to the mobile: <strong style="font-size: 1.1em;">7731879173</strong>.</p>
            <p>If the money was not deducted from your account or has already been refunded, click the button below to make the payment again.</p>
        </div>
        <button id="initiatePaymentBtn">Join and Pay â‚¹1000 Membership</button>
    </div>
    <div id="payment-review" style="display:none; margin-top:10px;">
<h3>Payment Review</h3>
        <p style="color:orange;">Your payment is under review. We will verify it within 6 hours. Would you like to access the courses quickly in 30 minuts, call on this number +917731879173. Thank you for your patience!</p>
    </div>

    <div id="course-access" style="display:none; margin-top:10px;">
        <h3>Access Your Paid Courses</h3>
        <p style="color:green;">You are already a registered paid member. To access your exclusive course content, please click the button below.</p>
        <button id="coursesBtn">Access Courses</button>
    </div>

    <div class="card">
        <button id="toggleReferral" aria-expanded="false">Show/Hide Referral Details</button>
        <div id="referralSection" style="display:none;">
            <h3>Referral Overview</h3>
            <p>Total Referrals: <span id="referral-count">0</span></p>
            <h4>Withdrawal Summary</h4>
            <p><strong>Total Withdrawn as of now:</strong> <span id="total-withdrawn-display">â‚¹0</span></p>
            <p><strong>Available Balance:</strong> <span id="available-balance-display">â‚¹0</span></p>
            <p>Total Earnings: <span id="total-earnings">â‚¹0</span></p>
            <h3>Withdrawal History</h3>
            <p>You can view all your past withdrawal transactions using the link below.<br>
            <a href="withdraw_history.html">View Withdrawal History</a></p>
            <table aria-label="Referral History Table">
                <thead>
                    <tr>
                        <th>Level</th>
                        <th>Name</th>
                        <th>Mobile</th>
                        <th>Email</th>
                        <th>Payment Status</th>
                        <th>Earning</th>
                    </tr>
                </thead>
                <tbody id="referral-details"></tbody>
            </table>
            <div class="card">
                <h3>Withdraw Earnings</h3>
                <p id="withdraw-status"></p>
                <div style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">
                    <button id="withdrawBtn">Request Withdrawal</button>
                </div>
            </div>
        </div>
    </div>

    <div id="admin-section" class="admin-section" style="display:none">
        <h3>Admin: Pending Withdrawals</h3>
        <div id="withdrawal-list"></div>
        <hr>
        <h3>Admin: Pending Manual Payments</h3>
        <div id="manual-payment-list"></div>
    </div>

    <div id="withdrawModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="withdrawModalTitle" aria-describedby="withdrawModalDescription" tabindex="-1">
        <div class="modal-content">
            <button class="close-button" aria-label="Close Withdrawal Modal">&times;</button>
            <h3 id="withdrawModalTitle">Withdrawal Request</h3>
            <p id="withdrawModalDescription" class="visually-hidden">Fill out the form below to request a withdrawal of your earnings.</p>
            <div class="modal-input-group">
                <label for="totalAmount">Total Amount:</label>
                <input type="text" id="totalAmount" value="â‚¹0" readonly>
            </div>
            <div class="modal-input-group">
                <label for="paymentMethod">Payment Method:</label>
                <select id="paymentMethod">
                    <option value="">Select Method</option>
                    <option value="phonepay">PhonePe</option>
                    <option value="googlepay">Google Pay</option>
                    <option value="upi">UPI</option>
                </select>
            </div>
            <div id="paymentDetails" style="display:none;">
                <div class="modal-input-group">
                    <label for="paymentId">Enter UPI ID/Number:</label>
                    <input type="text" id="paymentId" placeholder="Enter your ID">
                </div>
                <div class="modal-input-group">
                    <label for="availableAmount">Available Amount:</label>
                    <input type="text" id="availableAmount" value="â‚¹0" readonly>
                </div>
                <div class="modal-input-group">
                    <label for="withdrawAmount">Withdraw Amount:</label>
                    <input type="number" id="withdrawAmount" placeholder="Enter amount to withdraw [Minimum 100]">
                </div>
            </div>
            <div class="modal-actions">
                <button id="submitWithdrawal" disabled>Submit Withdrawal</button>
                <button id="cancelWithdrawal">Cancel</button>
            </div>
        </div>
    </div>

    <div id="paymentFormModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="paymentFormModalTitle" aria-describedby="paymentFormModalDescription" tabindex="-1">
        <div class="modal-content">
            <button class="close-button" id="closePaymentFormModal" aria-label="Close Payment Form Modal">&times;</button>
            <h3 id="paymentFormModalTitle">Complete Your Membership Payment</h3>
            <p id="paymentFormModalDescription" class="visually-hidden">Follow the instructions to make your membership payment and submit the details.</p>

            <div style="background-color: #fff3cd; border: 1px solid #ffeeba; border-radius: 5px; padding: 15px; margin-bottom: 20px; color: #856404;">
                <p style="font-weight: bold; margin-bottom: 10px;">Important Payment Instructions:</p>
                <p>
                    You need to click on the **Submit Payment Details** button after your manual payment, otherwise the admin will not receive your payment request.
                </p>
                <p style="margin-top: 10px;">
                    For faster course activation after a successful payment, please call the admin on:
                    <strong style="color: #007bff; font-size: 1.1em;">7731879173</strong>.
                </p>
            </div>
            <div class="instruction-box">
                To become a paid member, please transfer **â‚¹1000** using one of the methods below. After payment, fill out the form and submit it for verification. Your access will be granted within 6 hours, If it is not granded, call on my number.
            </div>

            <h4>Your Payment Information:</h4>
            <div class="modal-input-group">
                <label for="paymentFullName">Full Name:</label>
                <input type="text" id="paymentFullName" placeholder="Enter your full name" readonly>
            </div>
            <div class="modal-input-group">
                <label for="paymentPhoneNumber">Phone Number:</label>
                <input type="text" id="paymentPhoneNumber" placeholder="Enter your phone number" readonly>
            </div>
            <div class="modal-input-group">
                <label for="paymentEmail">Email:</label>
                <input type="text" id="paymentEmail" placeholder="Enter your email" readonly>
            </div>

            <div class="modal-input-group">
                <label for="chosenPaymentMethod">Payment Method You Will Use:</label>
                <select id="chosenPaymentMethod">
                    <option value="">-- Select Payment Method --</option>
                    <option value="upi_id">UPI ID</option>
                    <option value="phonepe_number">PhonePe Number</option>
                    <option value="googlepay_number">Google Pay Number</option>
                    <option value="qr_code">QR Code</option>
                    <option value="bank_transfer">Bank Account Transfer</option>
                </select>
            </div>

            <div id="paymentDetailsDisplay" class="payment-display-section">
                </div>

<div class="modal-input-group">
                <input type="checkbox" id="paymentConfirmationCheckbox">
                <label for="paymentConfirmationCheckbox">Select this checkbox if you have already made the payment.</label>
                <p>Without making the payment, you cannot submit this form.</p>
            </div>            
<div class="modal-actions">
                <button id="submitManualPayment" disabled>Submit Payment Details</button>
                <button id="cancelManualPayment">Cancel</button>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 Accessible World Tutorials</p>
        <a href="privacy.html" target="_blank">Privacy Policy</a>
        <a href="terms.html" target="_blank">Terms of Service</a>
        <a href="contact.html" target="_blank">Contact Us</a>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import {
            getFirestore, doc, getDoc, collection,
            query, where, getDocs, updateDoc,
            addDoc, serverTimestamp
        } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";


        const firebaseConfig = {
            apiKey: "AIzaSyBWtr_ZwK8hfA1We-yq9uUOjw5C6wXhx0k",
            authDomain: "accessibleworld-7f599.firebaseapp.com",
            projectId: "accessibleworld-7f599",
            storageBucket: "accessibleworld-7f599.appspot.com",
            messagingSenderId: "264437218598",
            appId: "1:264437218598:web:cae58c1e578c7b08b815e7",
            measurementId: "G-1QRWXYRZ76"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Profile elements
        const profileBtn = document.getElementById("profileBtn");
        const profileDetails = document.getElementById("profileDetails");
        const nameField = document.getElementById("user-name");
        const mobileField = document.getElementById("user-mobile");
        const emailField = document.getElementById("user-email");
        const paymentField = document.getElementById("user-payment-status");
        const logoutBtn = document.getElementById("logout");

        // Referral elements
        const referralLinkField = document.getElementById("referral-link");
        const copyLinkBtn = document.getElementById("copyLink");
        const toggleReferralBtn = document.getElementById("toggleReferral");
        const referralSection = document.getElementById("referralSection");
        const referralCountField = document.getElementById("referral-count");
        const earningsField = document.getElementById("total-earnings");
        const referralDetails = document.getElementById("referral-details");
        const totalWithdrawnDisplay = document.getElementById("total-withdrawn-display");
        const availableBalanceDisplay = document.getElementById("available-balance-display");

        // Payment and Course Access elements
        const initiatePaymentBtn = document.getElementById("initiatePaymentBtn");
        const paymentRejectedSection = document.getElementById("payment-rejected");
        const paymentReviewSection = document.getElementById("payment-review");
        const paymentSection = document.getElementById("payment-section");
        const courseAccessSection = document.getElementById("course-access");
        const coursesBtn = document.getElementById("coursesBtn");

        // Withdrawal Modal elements
        const withdrawBtn = document.getElementById("withdrawBtn");
        const statusMessage = document.getElementById("withdraw-status");
        const withdrawModal = document.getElementById("withdrawModal");
        const withdrawModalCloseButton = withdrawModal.querySelector(".close-button");
        const totalAmountModal = document.getElementById("totalAmount");
        const paymentMethodDropdown = document.getElementById("paymentMethod");
        const paymentDetailsDiv = document.getElementById("paymentDetails");
        const paymentIdInput = document.getElementById("paymentId");
        const availableAmountInput = document.getElementById("availableAmount");
        const withdrawAmountInput = document.getElementById("withdrawAmount");
        const submitWithdrawalButton = document.getElementById("submitWithdrawal");
        const cancelWithdrawalButton = document.getElementById("cancelWithdrawal");

        // Admin Section elements
        const adminSection = document.getElementById("admin-section");
        const withdrawalList = document.getElementById("withdrawal-list");
        const manualPaymentList = document.getElementById("manual-payment-list");


        // Manual Payment Form Modal elements
        const paymentFormModal = document.getElementById("paymentFormModal");
        const closePaymentFormModalBtn = document.getElementById("closePaymentFormModal");
        const paymentFullName = document.getElementById("paymentFullName");
        const paymentPhoneNumber = document.getElementById("paymentPhoneNumber");
        const paymentEmail = document.getElementById("paymentEmail");
        const chosenPaymentMethod = document.getElementById("chosenPaymentMethod");
        const paymentDetailsDisplay = document.getElementById("paymentDetailsDisplay");
        const paymentConfirmationCheckbox = document.getElementById("paymentConfirmationCheckbox");
        const submitManualPaymentBtn = document.getElementById("submitManualPayment");
        const cancelManualPaymentBtn = document.getElementById("cancelManualPayment");


        let currentUserId, currentUserName, currentUserMobile, currentUserEmail, currentEarnings = 0;

        // --- Utility Functions ---
        function openModal(modalElement) {
            modalElement.style.display = "block";
            modalElement.setAttribute("aria-hidden", "false");
            document.body.classList.add("modal-open");
            // Find the first focusable element inside the modal and focus it
            const focusableElements = modalElement.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            const firstFocusableElement = focusableElements[0];
            if (firstFocusableElement) {
                firstFocusableElement.focus();
            } else {
                modalElement.querySelector('.close-button')?.focus();
            }
        }

        function closeModal(modalElement) {
            modalElement.style.display = "none";
            modalElement.setAttribute("aria-hidden", "true");
            document.body.classList.remove("modal-open");
            // Clear specific fields if needed
            if (modalElement === paymentFormModal) {
                chosenPaymentMethod.value = "";
                paymentDetailsDisplay.innerHTML = "";
                paymentDetailsDisplay.style.display = "none";
                paymentConfirmationCheckbox.checked = false;
                submitManualPaymentBtn.disabled = true;
            } else if (modalElement === withdrawModal) {
                paymentMethodDropdown.value = "";
                paymentDetailsDiv.style.display = "none";
                withdrawAmountInput.value = "";
                submitWithdrawalButton.disabled = true;
            }
        }

        async function fetchReferralLevels(uid, level = 1, max = 3) {
            if (level > max) return [];
            const q = query(collection(db, "users"), where("referredBy", "==", uid));
            const snap = await getDocs(q);
            let out = [];
            for (const ds of snap.docs) {
                const d = ds.data();
                out.push({ level, fullName: d.fullName, mobile: d.mobile, email: d.email, paymentStatus: d.paymentStatus, uid: ds.id });
                out = out.concat(await fetchReferralLevels(ds.id, level + 1, max));
            }
            return out;
        }

        async function fetchWithdrawalsForAdmin() {
            withdrawalList.innerHTML = "";
            const q = query(collection(db, "withdrawals"), where("status", "==", "Pending"));
            const snap = await getDocs(q);
            if (snap.empty) {
                withdrawalList.innerHTML = "<p>No pending withdrawal requests.</p>";
            } else {
                snap.forEach(docSnap => {
                    const data = docSnap.data();
                    const card = document.createElement("div");
                    card.className = "withdrawal-card";
                    card.innerHTML = `
                        <p><strong>Name:</strong> ${data.fullName}</p>
                        <p><strong>Email:</strong> ${data.email}</p>
                        <p><strong>Phone:</strong> ${data.phone}</p>
                        <p><strong>Amount:</strong> â‚¹${data.amount}</p>
                        <p><strong>Date:</strong> ${data.requestedAt?.toDate().toLocaleString() || "N/A"}</p>
                        <p><strong>Status:</strong> ${data.status}</p>
                    `;
                    withdrawalList.appendChild(card);
                });
            }
        }

        async function fetchManualPaymentsForAdmin() {
            manualPaymentList.innerHTML = "";
            // Query for manual payments with status "Pending"
            const q = query(collection(db, "manualPayments"), where("status", "==", "Pending"));
            const snap = await getDocs(q);

            if (snap.empty) {
                manualPaymentList.innerHTML = "<p>No pending manual payment requests.</p>";
            } else {
                snap.forEach(docSnap => {
                    const data = docSnap.data();
                    const card = document.createElement("div");
                    card.className = "withdrawal-card"; // Reusing style for consistency
                    card.innerHTML = `
                        <p><strong>User:</strong> ${data.fullName} (${data.email})</p>
                        <p><strong>Mobile:</strong> ${data.phoneNumber}</p>
                        <p><strong>Payment Method:</strong> ${datascreenshot

.paymentMethod}</p>
                        ${data.transactionId ? `<p><strong>Transaction ID:</strong> ${data.transactionId}</p>` : ''}
                        ${data.screenshotUrl ? `<p><a href="${data.screenshotUrl}" target="_blank">View Screenshot</a></p>` : ''}
                        <p><strong>Amount:</strong> â‚¹${data.amount || 'N/A'}</p>
                        <p><strong>Requested At:</strong> ${data.timestamp?.toDate().toLocaleString() || "N/A"}</p>
                        <button class="approve-manual-payment" data-uid="${data.userId}" data-docid="${docSnap.id}">Approve</button>
                        <button class="reject-manual-payment" data-uid="${data.userId}" data-docid="${docSnap.id}">Reject</button>
                    `;
                    manualPaymentList.appendChild(card);
                });

                // Add event listeners for approve/reject buttons
                manualPaymentList.querySelectorAll('.approve-manual-payment').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const userId = e.target.dataset.uid;
                        const docId = e.target.dataset.docid;
                        try {
                            // Update the manual payment request status
                            await updateDoc(doc(db, "manualPayments", docId), { status: "Approved" });
                            // Update the user's payment status
                            await updateDoc(doc(db, "users", userId), { paymentStatus: "Paid" });
                            alert("Payment approved and user status updated!");
                            // Refresh both lists for admin
                            fetchManualPaymentsForAdmin();
                            fetchWithdrawalsForAdmin(); // In case this action affected withdrawals
                            location.reload(); // Reload to update dashboard for admin
                        } catch (error) {
                            console.error("Error approving manual payment:", error);
                            alert("Failed to approve payment.");
                        }
                    });
                });

                manualPaymentList.querySelectorAll('.reject-manual-payment').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const userId = e.target.dataset.uid;
                        const docId = e.target.dataset.docid;
                        try {
                            // Update the manual payment request status
                            await updateDoc(doc(db, "manualPayments", docId), { status: "Rejected" });
                            // Update the user's payment status
                            await updateDoc(doc(db, "users", userId), { paymentStatus: "Rejected" }); // Set to Rejected
                            alert("Payment rejected and user status updated!");
                            // Refresh both lists for admin
                            fetchManualPaymentsForAdmin();
                            fetchWithdrawalsForAdmin();
                            location.reload(); // Reload to update dashboard for admin
                        } catch (error) {
                            console.error("Error rejecting manual payment:", error);
                            alert("Failed to reject payment.");
                        }
                    });
                });
            }
        }


        // --- Event Listeners ---
        onAuthStateChanged(auth, async user => {
            if (!user) {
                location.href = "index.html";
                return;
            }
            currentUserId = user.uid;
            currentUserEmail = user.email;

            const userDocRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userDocRef);

            if (!userDoc.exists()) {
                alert("No user data found! Please contact support.");
                return;
            }
            const userData = userDoc.data();
            currentUserName = userData.fullName || "";
            currentUserMobile = userData.mobile || "";

            // Populate profile details
            nameField.textContent = currentUserName;
            mobileField.textContent = currentUserMobile;
            emailField.textContent = currentUserEmail;
            paymentField.textContent = userData.paymentStatus || "Pending";

            // Populate payment form modal details (readonly)
            paymentFullName.value = currentUserName;
            paymentPhoneNumber.value = currentUserMobile;
            paymentEmail.value = currentUserEmail;

            // Set referral link
            referralLinkField.textContent = `${location.origin}register.html?ref=${user.uid}`;

            // Handle payment status display
            // Ensure only one of these sections is displayed at a time for the user
            paymentSection.style.display = "none";
            paymentReviewSection.style.display = "none";
            paymentRejectedSection.style.display = "none";
            courseAccessSection.style.display = "none";

            if (userData.paymentStatus === "Paid") {
                courseAccessSection.style.display = "block";
            } else if (userData.paymentStatus === "Pending Review") {
                paymentReviewSection.style.display = "block";
            } else if (userData.paymentStatus === "Rejected") {
                paymentSection.style.display = "block"; // Show payment button again
                paymentRejectedSection.style.display = "block"; // Show rejected message
            }
            else { // "Pending" or initial state
                paymentSection.style.display = "block";
            }


            // Fetch and display referral details
            const refs = await fetchReferralLevels(user.uid);
            referralCountField.textContent = refs.length;
            referralDetails.innerHTML = "";
            let calculatedReferralEarnings = 0;
            refs.forEach(r => {
                let earning = 0;
                if (r.paymentStatus === "Paid") {
                    if (r.level === 1) earning = 150;
                    else if (r.level === 2) earning = 100;
                    else if (r.level === 3) earning = 50;
                }
                calculatedReferralEarnings += earning;
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${r.level}</td><td>${r.fullName}</td><td>${r.mobile}</td><td>${r.email}</td><td>${r.paymentStatus}</td><td>â‚¹${earning}</td>`;
                referralDetails.append(tr);
            });

            // Update total referral earnings in database and local state
            await updateDoc(userDocRef, {
                totalReferralEarnings: calculatedReferralEarnings
            });

            const totalWithdrawn = userData.totalWithdrawnAmount || 0;
            const availableEarnings = calculatedReferralEarnings - totalWithdrawn;
            earningsField.textContent = `â‚¹${availableEarnings}`;
            currentEarnings = availableEarnings;
            totalAmountModal.value = `â‚¹${availableEarnings}`;
            availableAmountInput.value = `â‚¹${availableEarnings}`;
            totalWithdrawnDisplay.textContent = `â‚¹${totalWithdrawn}`;
            availableBalanceDisplay.textContent = `â‚¹${availableEarnings}`;

            // Admin specific logic
            if (userData.role === "admin") {
                adminSection.style.display = "block";
                await fetchWithdrawalsForAdmin();
                await fetchManualPaymentsForAdmin(); // Fetch manual payments for admin
            }
        });

        // Profile Button
        profileBtn.addEventListener('click', () => {
            const isExpanded = profileBtn.getAttribute("aria-expanded") === "true";
            profileBtn.setAttribute("aria-expanded", !isExpanded);
            profileDetails.style.display = isExpanded ? "none" : "block";
        });

        // Logout Button
        logoutBtn.onclick = () => signOut(auth).then(() => location.href = "index.html");

        // Copy Referral Link Button
        copyLinkBtn.onclick = () => {
            navigator.clipboard.writeText(referralLinkField.textContent);
            alert("Referral link copied to clipboard!");
        }

        // Toggle Referral Section Button
        toggleReferralBtn.addEventListener('click', () => {
            const isExpanded = toggleReferralBtn.getAttribute("aria-expanded") === "true";
            toggleReferralBtn.setAttribute("aria-expanded", !isExpanded);
            referralSection.style.display = isExpanded ? "none" : "block";
            toggleReferralBtn.textContent = isExpanded ? "Show/Hide Referral Details" : "Show/Hide Referral Details";
        });

        // Initiate Payment Button (Opens Payment Form Modal)
        initiatePaymentBtn.onclick = () => {
            openModal(paymentFormModal);
        };

        // Close Payment Form Modal Button
        closePaymentFormModalBtn.onclick = () => {
            closeModal(paymentFormModal);
        };
        cancelManualPaymentBtn.onclick = () => {
            closeModal(paymentFormModal);
        };

        // Dynamic content for chosenPaymentMethod dropdown
        chosenPaymentMethod.addEventListener('change', function() {
            const method = this.value;
            paymentDetailsDisplay.innerHTML = "";
            if (method) { // Only show if a method is selected
                paymentDetailsDisplay.style.display = "block";
            } else {
                paymentDetailsDisplay.style.display = "none";
            }

            switch (method) {
                case "upi_id":
                    paymentDetailsDisplay.innerHTML = `
                        <p><strong>Our UPI ID:</strong> <span style="font-weight: bold; color: #007bff;">7702675618@ybl</span></p>
                        <p>Open your UPI app (PhonePe, Google Pay, Paytm, etc.) and send â‚¹1000 to this UPI ID.</p>
                    `;
                    break;
                case "phonepe_number":
                    paymentDetailsDisplay.innerHTML = `
                        <p><strong>Our PhonePe Number:</strong> <span style="font-weight: bold; color: #007bff;">7702675618</span></p>
                        <p>Open PhonePe and send â‚¹1000 to this number.</p>
                    `;
                    break;
                case "googlepay_number":
                    paymentDetailsDisplay.innerHTML = `
                        <p><strong>Our Google Pay Number:</strong> <span style="font-weight: bold; color: #007bff;">8178879173</span></p>
                        <p>Open Google Pay and send â‚¹1000 to this number.</p>
                    `;
                    break;
                case "qr_code":
                    paymentDetailsDisplay.innerHTML = `
                        <p><strong>Scan this QR Code to Pay:</strong></p>
                        <img src="qr_scanner.png" alt="Payment QR Code" style="width: 200%; hight: auto;">
                        <p>Scan this QR code using any UPI app (PhonePe, Google Pay, Paytm, etc.) to complete your payment of â‚¹1000.</p>
                    `;
                    break;
                case "bank_transfer":
                    paymentDetailsDisplay.innerHTML = `
                        <p><strong>Bank Account Name:</strong> Pentakota Raviteja</p>
                        <p><strong>Account Number:</strong> 35838062455</p>
                        <p><strong>IFSC Code:</strong> SBIN0021121</p>
                        <p><strong>Bank Name:</strong> HDFC BANK</p>
                        <p>Transfer â‚¹1000 to the above bank account.</p>
                    `;
                    break;
                default:
                    paymentDetailsDisplay.innerHTML = "";
                    paymentDetailsDisplay.style.display = "none";
                    break;
            }
            validateManualPaymentForm();
        });

        // Validate manual payment form submission
        function validateManualPaymentForm() {
            const hasChosenMethod = chosenPaymentMethod.value !== "";
            const isConfirmed = paymentConfirmationCheckbox.checked;
            submitManualPaymentBtn.disabled = !(hasChosenMethod && isConfirmed);
        }

        paymentConfirmationCheckbox.addEventListener('change', validateManualPaymentForm);
        // transactionIdInput.addEventListener('input', validateManualPaymentForm); // No need to validate on transaction ID for button enablement

        // Submit Manual Payment Button
        submitManualPaymentBtn.onclick = async () => {
            const selectedMethod = chosenPaymentMethod.value;
            if (!selectedMethod) {
                alert("Please select a payment method.");
                return;
            }
            if (!paymentConfirmationCheckbox.checked) {
                alert("Please confirm that you have made the payment by checking the box.");
                return;
            }


            try {
                await addDoc(collection(db, "manualPayments"), {
                    userId: currentUserId,
                    fullName: currentUserName,
                    phoneNumber: currentUserMobile,
                    email: currentUserEmail,
                    paymentMethod: selectedMethod,
                    amount: 1000, // Fixed amount for membership
                    timestamp: serverTimestamp(),
                    status: "Pending" // Initial status for manual payments
                });

                // Update user's payment status to "Pending Review"
                const userRef = doc(db, "users", currentUserId);
                await updateDoc(userRef, { paymentStatus: "Pending Review" });

                alert("Your payment details have been submitted for review. Please allow up to 6 hours for verification. For faster activation, call 7731879173.");
                closeModal(paymentFormModal);
                location.reload(); // Reload to show the "Pending Review" message to the user
            } catch (e) {
                console.error("Error submitting manual payment:", e);
                alert("Failed to submit payment details. Please try again.");
            }
        };


        // Withdrawal Modal Logic
        withdrawBtn.onclick = () => {
            if (currentEarnings < 100) {
                statusMessage.textContent = "Minimum â‚¹100 to withdraw";
                return;
            }
            openModal(withdrawModal);
            totalAmountModal.value = `â‚¹${currentEarnings}`;
            availableAmountInput.value = `â‚¹${currentEarnings}`;
        };

        withdrawModalCloseButton.onclick = function() {
            closeModal(withdrawModal);
            withdrawBtn.focus(); // Return focus to the withdraw button
        }

        cancelWithdrawalButton.onclick = function() {
            closeModal(withdrawModal);
            withdrawBtn.focus(); // Return focus to the withdraw button
        }

        paymentMethodDropdown.addEventListener('change', function() {
            if (this.value) {
                paymentDetailsDiv.style.display = "block";
            } else {
                paymentDetailsDiv.style.display = "none";
                paymentIdInput.value = "";
                withdrawAmountInput.value = "";
            }
            validateWithdrawalForm();
        });

        paymentIdInput.addEventListener('input', validateWithdrawalForm);
        withdrawAmountInput.addEventListener('input', validateWithdrawalForm);

        function validateWithdrawalForm() {
            const amount = parseFloat(withdrawAmountInput.value);
            const isValidAmount = !isNaN(amount) && amount >= 100 && amount <= currentEarnings;
            const hasPaymentDetails = paymentMethodDropdown.value && paymentIdInput.value.trim() !== "";
            submitWithdrawalButton.disabled = !(isValidAmount && hasPaymentDetails);
        }

        submitWithdrawalButton.onclick = async () => {
            const selectedMethod = paymentMethodDropdown.value;
            const paymentId = paymentIdInput.value.trim();
            const requestedAmount = parseFloat(withdrawAmountInput.value);

            if (!selectedMethod || !paymentId) {
                alert("Please select a payment method and enter your UPI ID/Number.");
                return;
            }

            if (isNaN(requestedAmount) || requestedAmount < 100) {
                alert("Minimum withdrawal amount is â‚¹100.");
                return;
            }
            if (requestedAmount <= 0 || requestedAmount > currentEarnings) {
                alert(`Please enter a valid withdrawal amount (up to â‚¹${currentEarnings}).`);
                return;
            }

            try {
                await addDoc(collection(db, "withdrawals"), {
                    userId: currentUserId,
                    fullName: currentUserName,
                    email: currentUserEmail,
                    phone: currentUserMobile,
                    amount: requestedAmount,
                    paymentMethod: selectedMethod,
                    paymentId: paymentId,
                    requestedAt: serverTimestamp(),
                    status: "Pending"
                });
                statusMessage.textContent = "Withdrawal request submitted successfully! You will receive the amount within 24-48 hours.";

                // Update the total withdrawn amount in the database
                const userRef = doc(db, "users", currentUserId);
                const userData = (await getDoc(userRef)).data();
                const currentWithdrawn = userData?.totalWithdrawnAmount || 0;
                const newTotalWithdrawn = currentWithdrawn + requestedAmount;
                await updateDoc(userRef, {
                    totalWithdrawnAmount: newTotalWithdrawn
                });

                // Update the local currentEarnings variable and the displayed value
                currentEarnings -= requestedAmount;
                earningsField.textContent = `â‚¹${currentEarnings}`;
                totalAmountModal.value = `â‚¹${currentEarnings}`;
                availableAmountInput.value = `â‚¹${currentEarnings}`;

                alert("Withdrawal request submitted! You will receive the amount in 24-48 hours on the provided payment method.");
                closeModal(withdrawModal);
                // Consider reloading or re-fetching data here to update all displays if needed
            } catch (e) {
                console.error("Error submitting withdrawal request:", e);
                statusMessage.textContent = "Could not submit withdrawal request. Please try again.";
                alert("Failed to submit withdrawal request. Please try again.");
            }
        };

        // Courses Access Button
        coursesBtn.onclick = () => window.location.href = 'courses_telugu/courses.html';
    </script>
</body>
</html>