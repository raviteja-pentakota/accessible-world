<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Companion Dashboard | Accessible World</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8f9fa;
      color: #333;
      padding: 20px;
      line-height: 1.6;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    h2 {
      color: #0056b3;
      margin: 0;
    }
    .welcome-message {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 20px;
    }
    .dashboard-section {
      margin-top: 30px;
      padding: 20px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      background-color: #fcfcfc;
    }
    .dashboard-section h3 {
      color: #007bff;
      margin-top: 0;
    }
    .rides-table {
      width: 100%;
      border-collapse: collapse;
    }
    .rides-table th, .rides-table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    .rides-table th {
      background-color: #007bff;
      color: white;
    }
    .rides-table tr:nth-child(even) {
      background-color: #f2f2f2;
    }
    .earning-summary {
      font-size: 1.1em;
      font-weight: bold;
    }
    .earning-summary span {
      color: #28a745;
    }
    .buttons-group {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
      transition: background-color 0.3s ease;
    }
    #withdrawButton {
      background-color: #ffc107;
      color: #212529;
    }
    #withdrawButton:hover {
      background-color: #e0a800;
    }
    #logoutButton {
      background-color: #dc3545;
      color: white;
    }
    #logoutButton:hover {
      background-color: #c82333;
    }
    .modal {
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .hidden {
      display: none;
    }
    .modal-content {
      background-color: #fefefe;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 400px;
      border-radius: 8px;
      text-align: center;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }
    .close:hover, .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
    .loading {
      text-align: center;
      font-style: italic;
      color: #777;
    }
    #withdrawalMessage {
      margin-top: 15px;
      font-weight: bold;
    }
    input {
      width: calc(100% - 24px);
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    #submitWithdrawal {
      background-color: #28a745;
      color: white;
      margin-top: 10px;
    }
    #submitWithdrawal:hover {
      background-color: #218838;
    }
    #cancelWithdrawal {
      background-color: #6c757d;
      color: white;
    }
    #cancelWithdrawal:hover {
      background-color: #5a6268;
    }
  </style>
</head>
<body>

  <div class="container">
    <div class="header">
      <h2>Companion Dashboard</h2>
      <button id="logoutButton">Log Out</button>
    </div>
    <p class="welcome-message">Welcome, <span id="userName">...</span>!</p>

    <div class="dashboard-section">
      <h3>Your Rides and Earnings</h3>
      <div id="loadingRides" class="loading">Loading ride data...</div>
      <table class="rides-table" id="ridesTable" style="display:none;">
        <thead>
          <tr>
            <th>Ride Date</th>
            <th>Description</th>
            <th>Earnings</th>
          </tr>
        </thead>
        <tbody id="ridesBody">
          <!-- Ride data will be inserted here by JavaScript -->
        </tbody>
      </table>
    </div>

    <div class="dashboard-section">
      <h3>Total Earnings</h3>
      <p class="earning-summary">
        Total Income: <span id="totalEarnings">0.00</span> INR
      </p>
    </div>

    <div class="buttons-group">
      <button id="withdrawButton">Withdraw</button>
    </div>

  </div>

  <!-- Withdrawal Modal -->
  <div id="withdrawalModal" class="modal hidden">
    <div class="modal-content">
      <!-- FIX: Added aria-label for screen reader accessibility -->
      <span class="close" aria-label="Close dialog">&times;</span>
      <h3>Withdraw Funds</h3>
      <p>Enter the amount you wish to withdraw:</p>
      <input type="number" id="withdrawalAmount" placeholder="Amount in INR" step="0.01" min="1">
      <button id="submitWithdrawal">Submit Withdrawal</button>
      <button id="cancelWithdrawal">Cancel</button>
      <p id="withdrawalMessage"></p>
    </div>
  </div>

  <script type="module">
    // Import Firebase services
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    // Firebase config from your project
    const firebaseConfig = {
      apiKey: "AIzaSyBZUQXgfdDHrntbBVSVFf8Vvtp9V5qnERg",
      authDomain: "accessible-learn-and-win-ad21f.firebaseapp.com",
      projectId: "accessible-learn-and-win-ad21f",
      storageBucket: "accessible-learn-and-win-ad21f.appspot.com",
      messagingSenderId: "299849578412",
      appId: "1:299849578412:web:1e66a3292e35578f102c09",
      measurementId: "G-G832YW57EK"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Get DOM elements
    const userNameSpan = document.getElementById("userName");
    const loadingRidesDiv = document.getElementById("loadingRides");
    const ridesTable = document.getElementById("ridesTable");
    const ridesBody = document.getElementById("ridesBody");
    const totalEarningsSpan = document.getElementById("totalEarnings");
    const withdrawButton = document.getElementById("withdrawButton");
    const logoutButton = document.getElementById("logoutButton");
    const withdrawalModal = document.getElementById("withdrawalModal");
    const closeBtn = document.querySelector(".close");
    const submitWithdrawalBtn = document.getElementById("submitWithdrawal");
    const cancelWithdrawalBtn = document.getElementById("cancelWithdrawal");
    const withdrawalAmountInput = document.getElementById("withdrawalAmount");
    const withdrawalMessage = document.getElementById("withdrawalMessage");

    // Listen for authentication state changes
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // User is signed in, fetch user details
        const userDocRef = doc(db, "paid_volunteers", user.uid);
        const userDocSnap = await getDoc(userDocRef);

        if (userDocSnap.exists()) {
          const userData = userDocSnap.data();
          userNameSpan.textContent = userData.name || "Companion";
        } else {
          console.warn("User data not found in Firestore.");
          userNameSpan.textContent = "Companion";
        }

        // Now, fetch and display the ride data
        fetchRides();

      } else {
        // User is signed out, redirect to login page
        window.location.href = 'login.html'; // Or the correct path to your login page
      }
    });

    // Function to fetch and display ride data
    async function fetchRides() {
      // For now, we will use mock data. In a real app, this would query a "rides"
      // collection in Firestore filtered by the user's ID.
      try {
        // Mock ride data to demonstrate the dashboard's functionality
        const mockRides = [
          { date: '2024-05-10', description: 'Assisted with grocery shopping', earnings: 150.00 },
          { date: '2024-05-08', description: 'Accompanied for a hospital visit', earnings: 250.00 },
          { date: '2024-05-05', description: 'Help with document filing', earnings: 100.00 },
          { date: '2024-05-03', description: 'Local commute assistance', earnings: 120.00 }
        ];
        
        ridesBody.innerHTML = '';
        let total = 0;

        mockRides.forEach(ride => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${ride.date}</td>
            <td>${ride.description}</td>
            <td>${ride.earnings.toFixed(2)} INR</td>
          `;
          ridesBody.appendChild(row);
          total += ride.earnings;
        });

        totalEarningsSpan.textContent = total.toFixed(2);

      } catch (error) {
        console.error("Error fetching ride data:", error);
        ridesBody.innerHTML = '<tr><td colspan="3">Failed to load rides.</td></tr>';
      } finally {
        loadingRidesDiv.style.display = 'none';
        ridesTable.style.display = 'table';
      }
    }

    // Handle Logout
    logoutButton.addEventListener('click', async () => {
      try {
        await signOut(auth);
        window.location.href = 'login.html'; // Redirect to login page
      } catch (error) {
        console.error("Error signing out:", error);
        withdrawalMessage.textContent = "Failed to log out. Please try again.";
        withdrawalMessage.style.color = "red";
        withdrawalModal.classList.remove('hidden');
      }
    });

    // Show withdrawal modal
    withdrawButton.addEventListener('click', () => {
      withdrawalModal.classList.remove('hidden'); // Remove the 'hidden' class to show the modal
      withdrawalMessage.textContent = ''; // Clear any previous messages
    });

    // Hide modal
    closeBtn.addEventListener('click', () => {
      withdrawalModal.classList.add('hidden'); // Add the 'hidden' class to hide the modal
    });

    cancelWithdrawalBtn.addEventListener('click', () => {
      withdrawalModal.classList.add('hidden'); // Add the 'hidden' class to hide the modal
    });
    
    // Handle withdrawal submission
    submitWithdrawalBtn.addEventListener('click', () => {
      const amount = parseFloat(withdrawalAmountInput.value);
      if (isNaN(amount) || amount <= 0) {
        withdrawalMessage.textContent = "Please enter a valid amount.";
        withdrawalMessage.style.color = 'red';
        return;
      }

      // In a real application, you would send this request to a secure backend function
      // that validates the amount and processes the withdrawal.
      console.log(`Withdrawal request for ${amount} INR submitted.`);
      withdrawalMessage.textContent = `Withdrawal of ${amount.toFixed(2)} INR successful! It will be processed shortly.`;
      withdrawalMessage.style.color = 'green';
      withdrawalAmountInput.value = ''; // Clear input field
      setTimeout(() => {
        withdrawalModal.classList.add('hidden');
      }, 3000);
    });

    // Close modal if user clicks outside of it
    window.addEventListener('click', (event) => {
      if (event.target === withdrawalModal) {
        withdrawalModal.classList.add('hidden');
      }
    });

  </script>

</body>
</html>
