<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Give Feedback | Accessible World Tutorials</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
        }
        .card {
            background: #fff;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Feedback Form Styles */
        #feedback-form-section {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
        }
        #feedback-form-section label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
        #feedback-form-section input[type="text"],
        #feedback-form-section textarea,
        #feedback-form-section select {
            width: calc(100% - 22px); /* Adjusted for padding */
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            resize: vertical;
        }
        #feedback-form-section button {
            background: #4caf50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
        }
        #feedback-form-section button:hover {
            background: #43a047;
        }
        #feedbackMessage {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
        }

        /* Feedback Display Styles */
        #feedback-list-display h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }
        .feedback-item {
            background: #fff;
            border-left: 5px solid #007bff;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        }
        .feedback-item p {
            margin: 5px 0;
            font-size: 0.95em;
        }
        .feedback-item strong {
            color: #333;
        }
        .feedback-item .meta {
            font-size: 0.8em;
            color: #666;
            border-top: 1px dashed #eee;
            padding-top: 5px;
            margin-top: 10px;
        }
        
        /* Navigation/Header */
        .header {
            width: 100%;
            max-width: 800px;
            padding: 10px 0;
            text-align: right;
        }
        .header a {
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
            padding: 8px 15px;
            border: 1px solid #007bff;
            border-radius: 4px;
        }
        .header a:hover {
            background-color: #f0f8ff;
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="/dashboard.html" role="button">‚Üê Back to Dashboard</a>
    </div>

    <div class="container">
        <section id="feedback-form-section" class="card">
            <h2>Submit Your Valuable Feedback</h2>
<p>Your valuable suggestions help us enhance our accessibility training and content. Your feedback will be displayed on the main page of our website and inspire more users to join our platform.</p>
            <form id="feedbackForm" aria-labelledby="feedback-heading">
                
                <label for="feedbackName">Your Name (Required):</label>
                <input type="text" id="feedbackName" name="feedbackName" required aria-required="true" placeholder="Enter your full name">

                <label for="feedbackTopic">Feedback Topic Name:</label>
                <select id="feedbackTopic" name="feedbackTopic" required aria-required="true">
                    <option value="">-- Select Topic --</option>
                    <option value="Website Experience">Website Experience</option>
                    <option value="Courses/Content Quality">Courses/Content Quality</option>
                    <option value="Accessibility Features">Accessibility Features</option>
                    <option value="Support/Admin Response">Support/Admin Response</option>
                    <option value="General Suggestion">General Suggestion</option>
                </select>

                <label for="feedbackText">Your Feedback (Required):</label>
                <textarea id="feedbackText" name="feedbackText" rows="5" required aria-required="true" placeholder="Share your detailed feedback here..."></textarea>
                
                <button type="submit">Submit Feedback</button>
            </form>
            <p id="feedbackMessage" aria-live="polite"></p>
        </section>

        <section id="feedback-list-display">
            <h2>Recent User Feedback (Top 10)</h2>
            <div id="displayedFeedback" class="card">
                <p>Loading feedback...</p>
            </div>
        </section>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import {
            getFirestore, doc, getDoc, collection,
            query, orderBy, limit, getDocs,
            addDoc, serverTimestamp
        } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        // --- START: Firebase Configuration ---
        // REPLACE with your actual Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBWtr_ZwK8hfA1We-yq9uUOjw5C6wXhx0k",
            authDomain: "accessibleworld-7f599.firebaseapp.com",
            projectId: "accessibleworld-7f599",
            storageBucket: "accessibleworld-7f599.appspot.com",
            messagingSenderId: "264437218598",
            appId: "1:264437218598:web:cae58c1e578c7b08b815e7",
            measurementId: "G-1QRWXYRZ76"
        };


        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore(app);
        
        let currentUserId = null;
        let currentUserName = null;
        // --- END: Firebase Configuration ---


        // --- START: DOM Element References & Auth Setup ---
        const feedbackForm = document.getElementById('feedbackForm');
        const feedbackName = document.getElementById('feedbackName');
        const feedbackTopic = document.getElementById('feedbackTopic');
        const feedbackText = document.getElementById('feedbackText');
        const feedbackMessage = document.getElementById('feedbackMessage');
        const displayedFeedback = document.getElementById('displayedFeedback');

        // Authentication Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                // Fetch user data from Firestore to get their name
                try {
                    const userDoc = await getDoc(doc(db, "users", currentUserId));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        currentUserName = userData.fullName || "Member";
                        feedbackName.value = currentUserName;
                    }
                } catch (error) {
                    console.error("Error fetching user name:", error);
                }
                
                // Once authenticated, fetch existing feedback
                fetchAndDisplayFeedback();

            } else {
                // If not logged in, redirect to login page
                window.location.href = 'login.html'; 
            }
        });
        // --- END: DOM Element References & Auth Setup ---


        // --- START: Feedback Functions ---
        
        const renderFeedbackList = (feedbackList) => {
            displayedFeedback.innerHTML = ''; // Clear previous list

            if (!feedbackList || feedbackList.length === 0) {
                displayedFeedback.innerHTML = '<p>No feedback submitted yet. Be the first to share your thoughts! üöÄ</p>';
                return;
            }

            feedbackList.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'feedback-item';
                itemDiv.setAttribute('role', 'listitem');

                const date = item.timestamp?.toDate ? item.timestamp.toDate().toLocaleDateString('en-US', {
                    year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                }) : 'N/A';
                
                const safeText = item.text.replace(/</g, "&lt;").replace(/>/g, "&gt;");

                itemDiv.innerHTML = `
                    <p><strong>Topic:</strong> ${item.topic}</p>
                    <p>${safeText}</p>
                    <div class="meta">
                        Submitted by <strong>${item.name}</strong> on ${date}
                    </div>
                `;
                displayedFeedback.appendChild(itemDiv);
            });
        };

        const fetchAndDisplayFeedback = async () => {
            try {
                displayedFeedback.innerHTML = '<p>Loading recent feedback...</p>';
                
                // Query the 'feedback' collection, ordered by timestamp (newest first), limited to 10
                const q = query(collection(db, "feedback"), orderBy("timestamp", "desc"), limit(10));
                const snapshot = await getDocs(q);
                
                const feedbackList = snapshot.docs.map(doc => doc.data());
                renderFeedbackList(feedbackList);

            } catch (error) {
                console.error("Error fetching feedback:", error);
                displayedFeedback.innerHTML = '<p style="color: red;">Could not load feedback. Please try again later.</p>';
            }
        };

        feedbackForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            const name = feedbackName.value.trim();
            const topic = feedbackTopic.value;
            const text = feedbackText.value.trim();

            if (!name || !topic || !text) {
                feedbackMessage.textContent = 'Please fill all required fields.';
                feedbackMessage.style.color = 'red';
                return;
            }

            const submitButton = feedbackForm.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Submitting...';
            feedbackMessage.textContent = 'Sending feedback...';
            feedbackMessage.style.color = 'orange';

            try {
                const feedbackData = {
                    userId: currentUserId,
                    name: name,
                    topic: topic,
                    text: text,
                    timestamp: serverTimestamp() 
                };

                await addDoc(collection(db, "feedback"), feedbackData);

                feedbackForm.reset();
                if (currentUserName) { // Re-fill name if known
                    feedbackName.value = currentUserName;
                }

                feedbackMessage.textContent = 'Thank you! Your feedback has been submitted successfully. ‚úÖ';
                feedbackMessage.style.color = 'green';
                
                fetchAndDisplayFeedback(); // Refresh the displayed list

            } catch (error) {
                console.error("Error submitting feedback:", error);
                feedbackMessage.textContent = 'Submission failed. Please check your connection. ‚ùå';
                feedbackMessage.style.color = 'red';
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Submit Feedback';
            }
        });

        // Ensure that fetchAndDisplayFeedback is only called after auth check is complete, 
        // as implemented in the onAuthStateChanged listener.

        // --- END: Feedback Functions ---

    </script>
</body>
</html>